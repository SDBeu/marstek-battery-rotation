# ============================================================================
# MARSTEK 3-BATTERY ROTATION SYSTEM
# Intelligente batterij rotatie op basis van P1 meter metingen
# ============================================================================
#
# Batterij Mapping:
# - Fase A (schuin):  sensor.marstek_venuse_d828_state_of_charge
# - Fase B (plat):    sensor.marstek_venuse_3_0_9a7d_state_of_charge
# - Fase C (geen):    sensor.marstek_venuse_state_of_charge
#
# P1 Meter: sensor.p1_meter_power
#   - Negatief = teruglevering aan net (zonoverschot)
#   - Positief = verbruik van net
# ============================================================================

# ============================================================================
# TEMPLATE SENSORS
# Bepaal welke batterij het leegst/volst is
# ============================================================================
template:
  - sensor:
      # Leegste batterij (voor laden bij zonoverschot)
      # Bij unavailable: assume 100% (vol) zodat die niet geselecteerd wordt
      - name: "Battery Emptiest"
        unique_id: battery_emptiest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
          ] %}
          {{ (batteries | sort(attribute='soc') | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).soc }}

      # Volste batterij (voor ontladen bij verbruik)
      - name: "Battery Fullest"
        unique_id: battery_fullest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
          ] %}
          {{ (batteries | sort(attribute='soc', reverse=true) | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).soc }}

      # Current battery status overview
      - name: "Battery Status Overview"
        unique_id: battery_status_overview
        state: >
          Actief: {{ states('input_text.active_battery_fase') }}
        attributes:
          fase_a_soc: "{{ states('sensor.marstek_venuse_d828_state_of_charge') }}"
          fase_b_soc: "{{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') }}"
          fase_c_soc: "{{ states('sensor.marstek_venuse_state_of_charge') }}"
          emptiest: "{{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}%)"
          fullest: "{{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}%)"
          p1_power: "{{ states('sensor.p1_meter_power') }}W"
          last_switch: "{{ states('input_datetime.last_battery_switch') }}"

  # Binary sensors voor threshold tracking (timer in dashboard)
  - binary_sensor:
      - name: "Marstek Solar Excess Zone"
        unique_id: marstek_solar_excess_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) < -200 }}"
        icon: "{{ 'mdi:solar-power' if this.state == 'on' else 'mdi:solar-power-variant' }}"

      - name: "Marstek Grid Consumption Zone"
        unique_id: marstek_grid_consumption_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) > 200 }}"
        icon: "{{ 'mdi:transmission-tower' if this.state == 'on' else 'mdi:transmission-tower-off' }}"

  # Night charging sensors
  - sensor:
      - name: "Marstek Capacity Deficit"
        unique_id: marstek_capacity_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-alert
        state: >
          {% set desired = states('input_number.desired_total_capacity')|float(10) %}
          {# Bij unavailable: assume 5 kWh (vol) per batterij #}
          {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
          {% set cap_b = states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5) %}
          {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
          {% set current = cap_a + cap_b + cap_c %}
          {{ [0, desired - current]|max|round(2) }}

      - name: "Marstek Night Hours"
        unique_id: marstek_night_hours
        unit_of_measurement: "h"
        icon: mdi:clock-time-eight
        state: >
          {% set night_start = states('input_datetime.night_mode_start_time') %}
          {% set day_start = states('input_datetime.day_mode_start_time') %}
          {% if night_start not in ['unknown', 'unavailable'] and day_start not in ['unknown', 'unavailable'] %}
            {% set ns = strptime(night_start, '%H:%M:%S') %}
            {% set ds = strptime(day_start, '%H:%M:%S') %}
            {% set night_minutes = ns.hour * 60 + ns.minute %}
            {% set day_minutes = ds.hour * 60 + ds.minute %}
            {% if day_minutes > night_minutes %}
              {{ ((day_minutes - night_minutes) / 60)|round(1) }}
            {% else %}
              {{ ((1440 - night_minutes + day_minutes) / 60)|round(1) }}
            {% endif %}
          {% else %}
            6
          {% endif %}

      - name: "Marstek Required Charging Power"
        unique_id: marstek_required_charging_power
        unit_of_measurement: "W"
        icon: mdi:flash
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {% set net_deficit = [0, deficit - expected_pv]|max %}
          {% set hours = states('sensor.marstek_night_hours')|float(6) %}
          {% set max_power = 2500 %}
          {% if hours > 0 and net_deficit > 0 %}
            {{ [((net_deficit / hours) * 1000)|round(0), max_power]|min }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek Estimated Charging Power"
        unique_id: marstek_estimated_charging_power
        unit_of_measurement: "W"
        icon: mdi:flash-outline
        state: >
          {% set night_start_str = states('input_datetime.night_mode_start_time') %}
          {% if night_start_str in ['unknown', 'unavailable'] %}
            0
          {% else %}
            {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
            {% set night_hour = night_start.hour + night_start.minute / 60 %}
            {% set current_hour = now().hour + now().minute / 60 %}
            {# Uren tot nachtmodus (rekening houdend met middernacht) #}
            {% if night_hour > current_hour %}
              {% set hours_until_night = night_hour - current_hour %}
            {% else %}
              {% set hours_until_night = 24 - current_hour + night_hour %}
            {% endif %}
            {# Huidige ontlading (positief = ontladen) #}
            {% set current_discharge = states('sensor.marstek_system_total_grid_power_2')|float(0) %}
            {% set discharge_kwh = (current_discharge / 1000) * hours_until_night if current_discharge > 0 else 0 %}
            {# Geschatte capaciteit bij nachtmodus start #}
            {% set current_cap = states('sensor.marstek_system_total_remaining_capacity_2')|float(0) %}
            {% set estimated_cap = [current_cap - discharge_kwh, 0]|max %}
            {# Geschat deficit #}
            {% set desired = states('input_number.desired_total_capacity')|float(10) %}
            {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
            {% set estimated_deficit = [desired - estimated_cap - expected_pv, 0]|max %}
            {# Geschat laadvermogen #}
            {% set night_hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set max_power = 2500 %}
            {% if night_hours > 0 and estimated_deficit > 0 %}
              {{ [((estimated_deficit / night_hours) * 1000)|round(0), max_power]|min }}
            {% else %}
              0
            {% endif %}
          {% endif %}
        attributes:
          hours_until_night: >
            {% set night_start_str = states('input_datetime.night_mode_start_time') %}
            {% if night_start_str in ['unknown', 'unavailable'] %}
              0
            {% else %}
              {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
              {% set night_hour = night_start.hour + night_start.minute / 60 %}
              {% set current_hour = now().hour + now().minute / 60 %}
              {% if night_hour > current_hour %}
                {{ (night_hour - current_hour)|round(1) }}
              {% else %}
                {{ (24 - current_hour + night_hour)|round(1) }}
              {% endif %}
            {% endif %}
          estimated_discharge_kwh: >
            {% set night_start_str = states('input_datetime.night_mode_start_time') %}
            {% if night_start_str in ['unknown', 'unavailable'] %}
              0
            {% else %}
              {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
              {% set night_hour = night_start.hour + night_start.minute / 60 %}
              {% set current_hour = now().hour + now().minute / 60 %}
              {% if night_hour > current_hour %}
                {% set hours_until = night_hour - current_hour %}
              {% else %}
                {% set hours_until = 24 - current_hour + night_hour %}
              {% endif %}
              {% set current_discharge = states('sensor.marstek_system_total_grid_power_2')|float(0) %}
              {{ ((current_discharge / 1000) * hours_until)|round(2) if current_discharge > 0 else 0 }}
            {% endif %}

      - name: "Marstek Expected PV Tomorrow"
        unique_id: marstek_expected_pv_tomorrow
        unit_of_measurement: "kWh"
        icon: mdi:solar-power-variant
        state: >
          {% set sunny_hours = states('sensor.marstek_sunny_hours_tomorrow')|float(0) %}
          {% set kwh_per_hour = states('input_number.pv_production_per_sunny_hour')|float(1.5) %}
          {{ (sunny_hours * kwh_per_hour)|round(1) }}

      - name: "Marstek Net Charging Deficit"
        unique_id: marstek_net_charging_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-charging-outline
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {{ [0, deficit - expected_pv]|max|round(2) }}

      - name: "Marstek Charging Plan"
        unique_id: marstek_charging_plan
        icon: mdi:battery-charging-wireless
        state: >
          {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
          {% set cap_b = states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5) %}
          {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
          {% set avail_a = [5 - cap_a, 0]|max %}
          {% set avail_b = [5 - cap_b, 0]|max %}
          {% set avail_c = [5 - cap_c, 0]|max %}
          {% set bats = [
            {'name': 'A', 'avail': avail_a},
            {'name': 'B', 'avail': avail_b},
            {'name': 'C', 'avail': avail_c}
          ] %}
          {% set sorted_bats = bats | sort(attribute='avail', reverse=true) | list %}
          {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
          {% set hours = states('sensor.marstek_night_hours')|float(6) %}
          {% set ns = namespace(remaining=deficit, parts=[]) %}
          {% for bat in sorted_bats %}
            {% set charge = [ns.remaining, bat.avail]|min %}
            {% if charge > 0.1 %}
              {% set power = [((charge / hours) * 1000)|int, 2500]|min %}
              {% set ns.parts = ns.parts + [bat.name ~ ':' ~ charge|round(1) ~ 'kWh@' ~ power ~ 'W'] %}
            {% endif %}
            {% set ns.remaining = [ns.remaining - charge, 0]|max %}
          {% endfor %}
          {{ ns.parts | join(' | ') if ns.parts else 'Geen laden nodig' }}
        attributes:
          fase_a_charge: >
            {% set cap = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}
          fase_b_charge: >
            {% set cap = states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}
          fase_c_charge: >
            {% set cap = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}

  # Trigger-based sensor voor zonuren morgen (update elk uur vanaf 17:00)
  - trigger:
      - platform: time
        at:
          - "17:00:00"
          - "18:00:00"
          - "19:00:00"
          - "20:00:00"
          - "21:00:00"
          - "22:00:00"
          - "23:00:00"
      - platform: homeassistant
        event: start
    action:
      - service: weather.get_forecasts
        data:
          type: hourly
        target:
          entity_id: weather.forecast_home
        response_variable: forecast
    sensor:
      - name: "Marstek Sunny Hours Tomorrow"
        unique_id: marstek_sunny_hours_tomorrow
        unit_of_measurement: "h"
        icon: mdi:weather-sunny
        state: >
          {% set tomorrow = (now() + timedelta(days=1)).date() %}
          {% set forecasts = forecast['weather.forecast_home']['forecast'] | default([]) %}
          {% set sunny_count = namespace(count=0) %}
          {% for f in forecasts %}
            {% set forecast_date = as_datetime(f.datetime).date() %}
            {% set forecast_hour = as_datetime(f.datetime).hour %}
            {% if forecast_date == tomorrow and forecast_hour >= 7 and forecast_hour <= 20 %}
              {% if f.condition == 'sunny' %}
                {% set sunny_count.count = sunny_count.count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ sunny_count.count }}
        attributes:
          last_update: "{{ now().isoformat() }}"
          forecast_date: "{{ (now() + timedelta(days=1)).date() }}"

# ============================================================================
# INPUT HELPERS
# Tracking en configuratie
# ============================================================================
input_text:
  active_battery_fase:
    name: "Actieve Batterij Fase"
    initial: "fase_a"
    icon: mdi:battery-charging

input_number:
  battery_switch_delay_minutes:
    name: "Minimale Tijd Tussen Switches"
    min: 1
    max: 30
    step: 1
    initial: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand

  desired_total_capacity:
    name: "Gewenste Capaciteit bij Dagstart"
    min: 0
    max: 15
    step: 0.5
    initial: 10
    unit_of_measurement: "kWh"
    icon: mdi:battery-charging-high

  pv_production_per_sunny_hour:
    name: "PV Productie per Zonuur"
    min: 0
    max: 5
    step: 0.1
    initial: 1.5
    unit_of_measurement: "kWh"
    icon: mdi:solar-power

input_datetime:
  last_battery_switch:
    name: "Laatste Batterij Switch"
    has_date: true
    has_time: true
    icon: mdi:clock-outline

  night_mode_start_time:
    name: "Nachtmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-night

  day_mode_start_time:
    name: "Dagmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-sunny

input_boolean:
  battery_rotation_enabled:
    name: "Batterij Rotatie Systeem"
    initial: true
    icon: mdi:autorenew

# ============================================================================
# AUTOMATIONS
# ============================================================================
automation:
  # --------------------------------------------------------------------------
  # MANUAL TOGGLE OFF - Alle batterijen naar Manual
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_off
    alias: "Marstek: Manual Toggle OFF"
    description: "Wanneer rotatie manueel uitgezet wordt, alle batterijen naar Manual"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "off"
    action:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      - service: notify.persistent_notification
        data:
          title: "üî¥ Marstek - Rotatie UIT"
          message: "Alle batterijen op Manual mode"

  # --------------------------------------------------------------------------
  # MANUAL TOGGLE ON - Volste batterij naar Auto
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_on
    alias: "Marstek: Manual Toggle ON"
    description: "Wanneer rotatie manueel aangezet wordt, volste batterij naar Auto"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "on"
    action:
      - variables:
          fullest: "{{ states('sensor.battery_fullest') }}"

      # Activeer volste batterij
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ fullest }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      - service: notify.persistent_notification
        data:
          title: "üü¢ Marstek - Rotatie AAN"
          message: >
            Volste batterij geactiveerd: {{ fullest | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}

  # --------------------------------------------------------------------------
  # SOLAR EXCESS - Switch naar leegste batterij
  # --------------------------------------------------------------------------
  - id: marstek_solar_excess_switch
    alias: "Marstek: Solar Excess - Switch to Emptiest"
    description: "Bij zonoverschot: switch naar leegste batterij om op te laden"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        below: -200  # Teruglevering > 200W (negatief = teruglevering)
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != leegste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_emptiest') }}

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Zonoverschot"
          message: >
            Teruglevering: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}% SOC)

      # Eerst leegste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_emptiest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # GRID CONSUMPTION - Switch naar volste batterij
  # --------------------------------------------------------------------------
  - id: marstek_grid_consumption_switch
    alias: "Marstek: Grid Consumption - Switch to Fullest"
    description: "Bij netverbruik: switch naar volste batterij om te ontladen"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        above: 200  # Verbruik > 200W
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != volste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_fullest') }}

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Netverbruik"
          message: >
            Verbruik: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}% SOC)

      # Eerst volste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_fullest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # NIGHT MODE - Multi-batterij nachtladen
  # --------------------------------------------------------------------------
  - id: marstek_night_charging
    alias: "Marstek: Night Charging"
    description: "Laad batterijen tijdens nachtmodus - verdeelt deficit over meerdere batterijen"
    trigger:
      - platform: time
        at: input_datetime.night_mode_start_time
    action:
      # Zet rotatie systeem UIT
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Bereken laadplan - verdeelt deficit over batterijen (leegste eerst)
      - variables:
          deficit: "{{ states('sensor.marstek_capacity_deficit')|float(0) }}"
          expected_pv: "{{ states('sensor.marstek_expected_pv_tomorrow')|float(0) }}"
          net_deficit: "{{ states('sensor.marstek_net_charging_deficit')|float(0) }}"
          sunny_hours: "{{ states('sensor.marstek_sunny_hours_tomorrow')|int(0) }}"
          night_hours: "{{ states('sensor.marstek_night_hours')|float(6) }}"
          night_end: "{{ states('input_datetime.day_mode_start_time')[:5] }}"
          night_start: "{{ states('input_datetime.night_mode_start_time')[:5] }}"
          max_power: 2500

          # Bereken laadplan per batterij
          charging_plan: >
            {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
            {% set cap_b = states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5) %}
            {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
            {% set avail_a = [5 - cap_a, 0]|max %}
            {% set avail_b = [5 - cap_b, 0]|max %}
            {% set avail_c = [5 - cap_c, 0]|max %}
            {% set bats = [
              {'id': 'a', 'name': 'Fase A', 'avail': avail_a, 'device_id': 'c1fbfff25b11fcecf3530135b0b08f2c'},
              {'id': 'b', 'name': 'Fase B', 'avail': avail_b, 'device_id': '79ea26ebcb0b77cc1e4acd1cc5af41f6'},
              {'id': 'c', 'name': 'Fase C', 'avail': avail_c, 'device_id': 'f15b9f6024d9a2b044ca90e77824a314'}
            ] %}
            {% set sorted_bats = bats | sort(attribute='avail', reverse=true) | list %}
            {% set deficit_val = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set ns = namespace(remaining=deficit_val, result=[]) %}
            {% for bat in sorted_bats %}
              {% set charge = [ns.remaining, bat.avail]|min %}
              {% set power = [((charge / hours) * 1000)|int, 2500]|min if charge > 0.1 else 0 %}
              {% set ns.remaining = [ns.remaining - charge, 0]|max %}
              {% set ns.result = ns.result + [{'name': bat.name, 'device_id': bat.device_id, 'charge': charge|round(2), 'power': power}] %}
            {% endfor %}
            {{ ns.result }}

      # Als netto deficit > 0: laad batterijen volgens plan
      - if:
          - condition: template
            value_template: "{{ net_deficit > 0 }}"
        then:
          # Batterij 1 (meeste ruimte/leegst)
          - if:
              - condition: template
                value_template: "{{ charging_plan[0].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[0].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[0].power }}"
                  enabled: true
                continue_on_error: true

          # Batterij 2
          - if:
              - condition: template
                value_template: "{{ charging_plan[1].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[1].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[1].power }}"
                  enabled: true
                continue_on_error: true

          # Batterij 3
          - if:
              - condition: template
                value_template: "{{ charging_plan[2].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[2].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[2].power }}"
                  enabled: true
                continue_on_error: true

          # Notificatie met laadinfo per batterij
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtladen"
              message: >
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Netto te laden: {{ net_deficit }} kWh

                {% for bat in charging_plan if bat.power > 0 %}
                {{ bat.name }}: {{ bat.charge }} kWh @ {{ bat.power }}W
                {% endfor %}
                Periode: {{ night_start }} - {{ night_end }}

        # Geen netto deficit: alles naar Manual
        else:
          - service: button.press
            target:
              entity_id:
                - button.fasea_schuin_d828_manual_mode
                - button.faseb_plat_v3_9a7d_manual_mode
                - button.fasec_geen_deb8_manual_mode
            continue_on_error: true

          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtmodus"
              message: >
                Geen nachtladen nodig.
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Alle batterijen op Manual.

  # --------------------------------------------------------------------------
  # MORNING MODE - Enable rotatie en start Fase A
  # --------------------------------------------------------------------------
  - id: marstek_enable_rotation_in_morning
    alias: "Marstek: Enable Rotation in Morning"
    description: "Zet batterij rotatie AAN, activeer Fase A, daarna clear nachtschema's"
    trigger:
      - platform: time
        at: input_datetime.day_mode_start_time
    action:
      # EERST: Zet rotatie systeem AAN (directe feedback)
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Activeer Fase A
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Deactiveer andere batterijen
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Dagmodus"
          message: "Batterij rotatie AAN - Fase A geactiveerd"

      # LAATST: Clear nacht laadschema's (traag, minder urgent)
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"
        continue_on_error: true

# ============================================================================
# SCRIPTS
# Helper scripts voor manuele controle
# ============================================================================
script:
  # Switch naar specifieke batterij
  marstek_activate_fase_a:
    alias: "Activeer Fase A (schuin)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase A (schuin) geactiveerd"

  marstek_activate_fase_b:
    alias: "Activeer Fase B (plat)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.faseb_plat_v3_9a7d_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_b"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase B (plat) geactiveerd"

  marstek_activate_fase_c:
    alias: "Activeer Fase C (geen)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasec_geen_deb8_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_c"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase C (geen) geactiveerd"

  # Zet alle batterijen naar Auto (voor testen)
  marstek_all_batteries_auto:
    alias: "Alle Batterijen Auto Mode"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_auto_mode
            - button.faseb_plat_v3_9a7d_auto_mode
            - button.fasec_geen_deb8_auto_mode
        continue_on_error: true

  # Zet alle batterijen naar Manual (emergency stop)
  marstek_all_batteries_manual:
    alias: "Alle Batterijen Manual Mode (STOP)"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      - service: notify.persistent_notification
        data:
          title: "üõë Marstek - Emergency Stop"
          message: "Alle batterijen gezet naar Manual mode"
