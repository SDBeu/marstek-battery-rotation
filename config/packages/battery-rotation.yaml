# ============================================================================
# MARSTEK 3-BATTERY ROTATION SYSTEM
# Intelligente batterij rotatie op basis van P1 meter metingen
# ============================================================================
#
# Batterij Mapping:
# - Fase A (schuin):  sensor.marstek_venuse_d828_state_of_charge
# - Fase B (plat):    sensor.marstek_venuse_3_0_9a7d_state_of_charge
# - Fase C (geen):    sensor.marstek_venuse_state_of_charge
#
# P1 Meter: sensor.p1_meter_power
#   - Negatief = teruglevering aan net (zonoverschot)
#   - Positief = verbruik van net
# ============================================================================

# ============================================================================
# TEMPLATE SENSORS
# Bepaal welke batterij het leegst/volst is
# ============================================================================
template:
  - sensor:
      # Leegste batterij (voor laden bij zonoverschot)
      # Bij unavailable: assume 100% (vol) zodat die niet geselecteerd wordt
      - name: "Battery Emptiest"
        unique_id: battery_emptiest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
          ] %}
          {{ (batteries | sort(attribute='soc') | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).soc }}

      # Volste batterij (voor ontladen bij verbruik)
      - name: "Battery Fullest"
        unique_id: battery_fullest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
          ] %}
          {{ (batteries | sort(attribute='soc', reverse=true) | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).soc }}

      # Current battery status overview
      - name: "Battery Status Overview"
        unique_id: battery_status_overview
        state: >
          Actief: {{ states('input_text.active_battery_fase') }}
        attributes:
          fase_a_soc: "{{ states('sensor.marstek_venuse_d828_state_of_charge') }}"
          fase_b_soc: "{{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') }}"
          fase_c_soc: "{{ states('sensor.marstek_venuse_state_of_charge') }}"
          emptiest: "{{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}%)"
          fullest: "{{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}%)"
          p1_power: "{{ states('sensor.p1_meter_power') }}W"
          last_switch: "{{ states('input_datetime.last_battery_switch') }}"

  # Binary sensors voor threshold tracking (timer in dashboard)
  - binary_sensor:
      - name: "Marstek Solar Excess Zone"
        unique_id: marstek_solar_excess_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) < -200 }}"
        icon: "{{ 'mdi:solar-power' if this.state == 'on' else 'mdi:solar-power-variant' }}"

      - name: "Marstek Grid Consumption Zone"
        unique_id: marstek_grid_consumption_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) > 200 }}"
        icon: "{{ 'mdi:transmission-tower' if this.state == 'on' else 'mdi:transmission-tower-off' }}"

  # Night charging sensors
  - sensor:
      - name: "Marstek Capacity Deficit"
        unique_id: marstek_capacity_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-alert
        state: >
          {% set desired = states('input_number.desired_total_capacity')|float(10) %}
          {# Bij unavailable: assume 5 kWh (vol) per batterij #}
          {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
          {% set cap_b = states('sensor.marstek_venuse_3_0_9a7d_remaining_capacity')|float(5) %}
          {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
          {% set current = cap_a + cap_b + cap_c %}
          {{ [0, desired - current]|max|round(2) }}

      - name: "Marstek Night Hours"
        unique_id: marstek_night_hours
        unit_of_measurement: "h"
        icon: mdi:clock-time-eight
        state: >
          {% set night_start = states('input_datetime.night_mode_start_time') %}
          {% set day_start = states('input_datetime.day_mode_start_time') %}
          {% if night_start not in ['unknown', 'unavailable'] and day_start not in ['unknown', 'unavailable'] %}
            {% set ns = strptime(night_start, '%H:%M:%S') %}
            {% set ds = strptime(day_start, '%H:%M:%S') %}
            {% set night_minutes = ns.hour * 60 + ns.minute %}
            {% set day_minutes = ds.hour * 60 + ds.minute %}
            {% if day_minutes > night_minutes %}
              {{ ((day_minutes - night_minutes) / 60)|round(1) }}
            {% else %}
              {{ ((1440 - night_minutes + day_minutes) / 60)|round(1) }}
            {% endif %}
          {% else %}
            6
          {% endif %}

      - name: "Marstek Required Charging Power"
        unique_id: marstek_required_charging_power
        unit_of_measurement: "W"
        icon: mdi:flash
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {% set net_deficit = [0, deficit - expected_pv]|max %}
          {% set hours = states('sensor.marstek_night_hours')|float(6) %}
          {% set max_power = 2500 %}
          {% if hours > 0 and net_deficit > 0 %}
            {{ [((net_deficit / hours) * 1000)|round(0), max_power]|min }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek Expected PV Tomorrow"
        unique_id: marstek_expected_pv_tomorrow
        unit_of_measurement: "kWh"
        icon: mdi:solar-power-variant
        state: >
          {% set sunny_hours = states('sensor.marstek_sunny_hours_tomorrow')|float(0) %}
          {% set kwh_per_hour = states('input_number.pv_production_per_sunny_hour')|float(1.5) %}
          {{ (sunny_hours * kwh_per_hour)|round(1) }}

      - name: "Marstek Net Charging Deficit"
        unique_id: marstek_net_charging_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-charging-outline
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {{ [0, deficit - expected_pv]|max|round(2) }}

  # Trigger-based sensor voor zonuren morgen (update elke avond om 22:00)
  - trigger:
      - platform: time
        at: "22:00:00"
      - platform: homeassistant
        event: start
    action:
      - service: weather.get_forecasts
        data:
          type: hourly
        target:
          entity_id: weather.forecast_home
        response_variable: forecast
    sensor:
      - name: "Marstek Sunny Hours Tomorrow"
        unique_id: marstek_sunny_hours_tomorrow
        unit_of_measurement: "h"
        icon: mdi:weather-sunny
        state: >
          {% set tomorrow = (now() + timedelta(days=1)).date() %}
          {% set forecasts = forecast['weather.forecast_home']['forecast'] | default([]) %}
          {% set sunny_count = namespace(count=0) %}
          {% for f in forecasts %}
            {% set forecast_date = as_datetime(f.datetime).date() %}
            {% set forecast_hour = as_datetime(f.datetime).hour %}
            {% if forecast_date == tomorrow and forecast_hour >= 7 and forecast_hour <= 20 %}
              {% if f.condition == 'sunny' %}
                {% set sunny_count.count = sunny_count.count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ sunny_count.count }}
        attributes:
          last_update: "{{ now().isoformat() }}"
          forecast_date: "{{ (now() + timedelta(days=1)).date() }}"

# ============================================================================
# INPUT HELPERS
# Tracking en configuratie
# ============================================================================
input_text:
  active_battery_fase:
    name: "Actieve Batterij Fase"
    initial: "fase_a"
    icon: mdi:battery-charging

input_number:
  battery_switch_delay_minutes:
    name: "Minimale Tijd Tussen Switches"
    min: 1
    max: 30
    step: 1
    initial: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand

  desired_total_capacity:
    name: "Gewenste Capaciteit bij Dagstart"
    min: 0
    max: 15
    step: 0.5
    initial: 10
    unit_of_measurement: "kWh"
    icon: mdi:battery-charging-high

  pv_production_per_sunny_hour:
    name: "PV Productie per Zonuur"
    min: 0
    max: 5
    step: 0.1
    initial: 1.5
    unit_of_measurement: "kWh"
    icon: mdi:solar-power

input_datetime:
  last_battery_switch:
    name: "Laatste Batterij Switch"
    has_date: true
    has_time: true
    icon: mdi:clock-outline

  night_mode_start_time:
    name: "Nachtmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-night

  day_mode_start_time:
    name: "Dagmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-sunny

input_boolean:
  battery_rotation_enabled:
    name: "Batterij Rotatie Systeem"
    initial: true
    icon: mdi:autorenew

# ============================================================================
# AUTOMATIONS
# ============================================================================
automation:
  # --------------------------------------------------------------------------
  # MANUAL TOGGLE OFF - Alle batterijen naar Manual
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_off
    alias: "Marstek: Manual Toggle OFF"
    description: "Wanneer rotatie manueel uitgezet wordt, alle batterijen naar Manual"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "off"
    action:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      - service: notify.persistent_notification
        data:
          title: "üî¥ Marstek - Rotatie UIT"
          message: "Alle batterijen op Manual mode"

  # --------------------------------------------------------------------------
  # MANUAL TOGGLE ON - Volste batterij naar Auto
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_on
    alias: "Marstek: Manual Toggle ON"
    description: "Wanneer rotatie manueel aangezet wordt, volste batterij naar Auto"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "on"
    action:
      - variables:
          fullest: "{{ states('sensor.battery_fullest') }}"

      # Activeer volste batterij
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ fullest }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      - service: notify.persistent_notification
        data:
          title: "üü¢ Marstek - Rotatie AAN"
          message: >
            Volste batterij geactiveerd: {{ fullest | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}

  # --------------------------------------------------------------------------
  # SOLAR EXCESS - Switch naar leegste batterij
  # --------------------------------------------------------------------------
  - id: marstek_solar_excess_switch
    alias: "Marstek: Solar Excess - Switch to Emptiest"
    description: "Bij zonoverschot: switch naar leegste batterij om op te laden"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        below: -200  # Teruglevering > 200W (negatief = teruglevering)
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != leegste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_emptiest') }}

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Zonoverschot"
          message: >
            Teruglevering: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}% SOC)

      # Eerst leegste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_emptiest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # GRID CONSUMPTION - Switch naar volste batterij
  # --------------------------------------------------------------------------
  - id: marstek_grid_consumption_switch
    alias: "Marstek: Grid Consumption - Switch to Fullest"
    description: "Bij netverbruik: switch naar volste batterij om te ontladen"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        above: 200  # Verbruik > 200W
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != volste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_fullest') }}

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Netverbruik"
          message: >
            Verbruik: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}% SOC)

      # Eerst volste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_fullest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # NIGHT MODE - Disable rotatie tijdens nacht laden
  # --------------------------------------------------------------------------
  - id: marstek_night_charging
    alias: "Marstek: Night Charging"
    description: "Laad leegste batterij tijdens nachtmodus tot gewenste capaciteit"
    trigger:
      - platform: time
        at: input_datetime.night_mode_start_time
    action:
      # Zet rotatie systeem UIT
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Bereken variabelen
      - variables:
          deficit: "{{ states('sensor.marstek_capacity_deficit')|float(0) }}"
          expected_pv: "{{ states('sensor.marstek_expected_pv_tomorrow')|float(0) }}"
          net_deficit: "{{ states('sensor.marstek_net_charging_deficit')|float(0) }}"
          power_needed: "{{ states('sensor.marstek_required_charging_power')|int(0) }}"
          sunny_hours: "{{ states('sensor.marstek_sunny_hours_tomorrow')|int(0) }}"
          emptiest: "{{ states('sensor.battery_emptiest') }}"
          night_end: "{{ states('input_datetime.day_mode_start_time')[:5] }}"
          night_start: "{{ states('input_datetime.night_mode_start_time')[:5] }}"

      # Als netto deficit > 0: laad leegste batterij
      - if:
          - condition: template
            value_template: "{{ net_deficit > 0 }}"
        then:
          # Laad leegste batterij met schema
          - choose:
              # Fase A is leegst
              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_a' }}"
                sequence:
                  - service: marstek_local_api.set_manual_schedule
                    data:
                      device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                      time_num: 0
                      start_time: "{{ night_start }}"
                      end_time: "{{ night_end }}"
                      power: "{{ -power_needed }}"
                      enabled: true
                    continue_on_error: true
                  - service: button.press
                    target:
                      entity_id:
                        - button.faseb_plat_v3_9a7d_manual_mode
                        - button.fasec_geen_deb8_manual_mode
                    continue_on_error: true

              # Fase B is leegst
              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_b' }}"
                sequence:
                  - service: marstek_local_api.set_manual_schedule
                    data:
                      device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                      time_num: 0
                      start_time: "{{ night_start }}"
                      end_time: "{{ night_end }}"
                      power: "{{ -power_needed }}"
                      enabled: true
                    continue_on_error: true
                  - service: button.press
                    target:
                      entity_id:
                        - button.fasea_schuin_d828_manual_mode
                        - button.fasec_geen_deb8_manual_mode
                    continue_on_error: true

              # Fase C is leegst
              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_c' }}"
                sequence:
                  - service: marstek_local_api.set_manual_schedule
                    data:
                      device_id: "f15b9f6024d9a2b044ca90e77824a314"
                      time_num: 0
                      start_time: "{{ night_start }}"
                      end_time: "{{ night_end }}"
                      power: "{{ -power_needed }}"
                      enabled: true
                    continue_on_error: true
                  - service: button.press
                    target:
                      entity_id:
                        - button.fasea_schuin_d828_manual_mode
                        - button.faseb_plat_v3_9a7d_manual_mode
                    continue_on_error: true

          # Notificatie met laadinfo
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtladen"
              message: >
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Netto te laden: {{ net_deficit }} kWh @ {{ power_needed }}W
                Batterij: {{ emptiest | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
                Periode: {{ night_start }} - {{ night_end }}

        # Geen netto deficit: alles naar Manual
        else:
          - service: button.press
            target:
              entity_id:
                - button.fasea_schuin_d828_manual_mode
                - button.faseb_plat_v3_9a7d_manual_mode
                - button.fasec_geen_deb8_manual_mode
            continue_on_error: true

          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtmodus"
              message: >
                Geen nachtladen nodig.
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Alle batterijen op Manual.

  # --------------------------------------------------------------------------
  # MORNING MODE - Enable rotatie en start Fase A
  # --------------------------------------------------------------------------
  - id: marstek_enable_rotation_in_morning
    alias: "Marstek: Enable Rotation in Morning"
    description: "Zet batterij rotatie AAN, clear nachtschema's en activeer Fase A"
    trigger:
      - platform: time
        at: input_datetime.day_mode_start_time
    action:
      # Clear nacht laadschema's van alle batterijen
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"
        continue_on_error: true

      # Zet rotatie systeem AAN
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Activeer Fase A
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Deactiveer andere batterijen
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Dagmodus"
          message: "Batterij rotatie AAN - Fase A geactiveerd"

# ============================================================================
# SCRIPTS
# Helper scripts voor manuele controle
# ============================================================================
script:
  # Switch naar specifieke batterij
  marstek_activate_fase_a:
    alias: "Activeer Fase A (schuin)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase A (schuin) geactiveerd"

  marstek_activate_fase_b:
    alias: "Activeer Fase B (plat)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.faseb_plat_v3_9a7d_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_b"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase B (plat) geactiveerd"

  marstek_activate_fase_c:
    alias: "Activeer Fase C (geen)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasec_geen_deb8_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_c"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase C (geen) geactiveerd"

  # Zet alle batterijen naar Auto (voor testen)
  marstek_all_batteries_auto:
    alias: "Alle Batterijen Auto Mode"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_auto_mode
            - button.faseb_plat_v3_9a7d_auto_mode
            - button.fasec_geen_deb8_auto_mode
        continue_on_error: true

  # Zet alle batterijen naar Manual (emergency stop)
  marstek_all_batteries_manual:
    alias: "Alle Batterijen Manual Mode (STOP)"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      - service: notify.persistent_notification
        data:
          title: "üõë Marstek - Emergency Stop"
          message: "Alle batterijen gezet naar Manual mode"
