# ============================================================================
# MARSTEK 3-BATTERY ROTATION SYSTEM
# Intelligente batterij rotatie op basis van P1 meter metingen
# ============================================================================
#
# Batterij Mapping:
# - Fase A (schuin):  sensor.marstek_venuse_d828_state_of_charge
# - Fase B (plat):    sensor.marstek_venuse_3_0_9a7d_state_of_charge
# - Fase C (geen):    sensor.marstek_venuse_state_of_charge
#
# P1 Meter: sensor.p1_meter_power
#   - Negatief = teruglevering aan net (zonoverschot)
#   - Positief = verbruik van net
# ============================================================================

# ============================================================================
# TEMPLATE SENSORS
# Bepaal welke batterij het leegst/volst is
# ============================================================================
template:
  - sensor:
      # Fase B remaining capacity (V3 firmware bug workaround)
      # V3 firmware: available = ruimte om te laden, dus remaining = rated - available
      - name: "Marstek Fase B Remaining Capacity"
        unique_id: marstek_fase_b_remaining_capacity
        unit_of_measurement: "kWh"
        icon: mdi:battery
        state: >
          {% set rated = states('sensor.marstek_venuse_3_0_9a7d_rated_capacity')|float(5.12) %}
          {% set available = states('sensor.marstek_venuse_3_0_9a7d_available_capacity')|float(0) %}
          {{ (rated - available) | round(2) }}

      # Leegste batterij (voor laden bij zonoverschot)
      # Bij unavailable: assume 100% (vol) zodat die niet geselecteerd wordt
      - name: "Battery Emptiest"
        unique_id: battery_emptiest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
          ] %}
          {{ (batteries | sort(attribute='soc') | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(100)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(100)}
            ] %}
            {{ (batteries | sort(attribute='soc') | first).soc }}

      # Volste batterij (voor ontladen bij verbruik)
      - name: "Battery Fullest"
        unique_id: battery_fullest_id
        state: >
          {% set batteries = [
            {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
            {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
            {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
          ] %}
          {{ (batteries | sort(attribute='soc', reverse=true) | first).name }}
        attributes:
          label: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).label }}
          soc: >
            {% set batteries = [
              {'name': 'fase_a', 'label': 'Fase A (schuin)', 'soc': states('sensor.marstek_venuse_d828_state_of_charge')|float(0)},
              {'name': 'fase_b', 'label': 'Fase B (plat)', 'soc': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0)},
              {'name': 'fase_c', 'label': 'Fase C (geen)', 'soc': states('sensor.marstek_venuse_state_of_charge')|float(0)}
            ] %}
            {{ (batteries | sort(attribute='soc', reverse=true) | first).soc }}

      # Current battery status overview
      - name: "Battery Status Overview"
        unique_id: battery_status_overview
        state: >
          Actief: {{ states('input_text.active_battery_fase') }}
        attributes:
          fase_a_soc: "{{ states('sensor.marstek_venuse_d828_state_of_charge') }}"
          fase_b_soc: "{{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') }}"
          fase_c_soc: "{{ states('sensor.marstek_venuse_state_of_charge') }}"
          emptiest: "{{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}%)"
          fullest: "{{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}%)"
          p1_power: "{{ states('sensor.p1_meter_power') }}W"
          last_switch: "{{ states('input_datetime.last_battery_switch') }}"

  # Binary sensors voor threshold tracking (timer in dashboard)
  - binary_sensor:
      - name: "Marstek Solar Excess Zone"
        unique_id: marstek_solar_excess_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) < -200 }}"
        icon: "{{ 'mdi:solar-power' if this.state == 'on' else 'mdi:solar-power-variant' }}"

      - name: "Marstek Grid Consumption Zone"
        unique_id: marstek_grid_consumption_zone
        state: "{{ states('sensor.p1_meter_power')|float(0) > 200 }}"
        icon: "{{ 'mdi:transmission-tower' if this.state == 'on' else 'mdi:transmission-tower-off' }}"

  # Night charging sensors
  - sensor:
      - name: "Marstek Capacity Deficit"
        unique_id: marstek_capacity_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-alert
        state: >
          {% set desired = states('input_number.desired_total_capacity')|float(10) %}
          {# Bij unavailable: assume 5 kWh (vol) per batterij #}
          {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
          {% set cap_b = states('sensor.marstek_fase_b_remaining_capacity')|float(5) %}
          {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
          {% set current = cap_a + cap_b + cap_c %}
          {{ [0, desired - current]|max|round(2) }}

      - name: "Marstek Night Hours"
        unique_id: marstek_night_hours
        unit_of_measurement: "h"
        icon: mdi:clock-time-eight
        state: >
          {% set night_start = states('input_datetime.night_mode_start_time') %}
          {% set day_start = states('input_datetime.day_mode_start_time') %}
          {% if night_start not in ['unknown', 'unavailable'] and day_start not in ['unknown', 'unavailable'] %}
            {% set ns = strptime(night_start, '%H:%M:%S') %}
            {% set ds = strptime(day_start, '%H:%M:%S') %}
            {% set night_minutes = ns.hour * 60 + ns.minute %}
            {% set day_minutes = ds.hour * 60 + ds.minute %}
            {% if day_minutes > night_minutes %}
              {{ ((day_minutes - night_minutes) / 60)|round(1) }}
            {% else %}
              {{ ((1440 - night_minutes + day_minutes) / 60)|round(1) }}
            {% endif %}
          {% else %}
            6
          {% endif %}

      - name: "Marstek Required Charging Power"
        unique_id: marstek_required_charging_power
        unit_of_measurement: "W"
        icon: mdi:flash
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {% set net_deficit = [0, deficit - expected_pv]|max %}
          {% set hours = states('sensor.marstek_night_hours')|float(6) %}
          {% set max_power = 2500 %}
          {% if hours > 0 and net_deficit > 0 %}
            {{ [((net_deficit / hours) * 1000)|round(0), max_power]|min }}
          {% else %}
            0
          {% endif %}

      - name: "Marstek Estimated Charging Power"
        unique_id: marstek_estimated_charging_power
        unit_of_measurement: "W"
        icon: mdi:flash-outline
        state: >
          {% set night_start_str = states('input_datetime.night_mode_start_time') %}
          {% if night_start_str in ['unknown', 'unavailable'] %}
            0
          {% else %}
            {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
            {% set night_hour = night_start.hour + night_start.minute / 60 %}
            {% set current_hour = now().hour + now().minute / 60 %}
            {# Uren tot nachtmodus (rekening houdend met middernacht) #}
            {% if night_hour > current_hour %}
              {% set hours_until_night = night_hour - current_hour %}
            {% else %}
              {% set hours_until_night = 24 - current_hour + night_hour %}
            {% endif %}
            {# Huidige ontlading (positief = ontladen) #}
            {% set current_discharge = states('sensor.marstek_system_total_grid_power_2')|float(0) %}
            {% set discharge_kwh = (current_discharge / 1000) * hours_until_night if current_discharge > 0 else 0 %}
            {# Geschatte capaciteit bij nachtmodus start #}
            {% set current_cap = states('sensor.marstek_system_total_remaining_capacity_2')|float(0) %}
            {% set estimated_cap = [current_cap - discharge_kwh, 0]|max %}
            {# Geschat deficit #}
            {% set desired = states('input_number.desired_total_capacity')|float(10) %}
            {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
            {% set estimated_deficit = [desired - estimated_cap - expected_pv, 0]|max %}
            {# Geschat laadvermogen #}
            {% set night_hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set max_power = 2500 %}
            {% if night_hours > 0 and estimated_deficit > 0 %}
              {{ [((estimated_deficit / night_hours) * 1000)|round(0), max_power]|min }}
            {% else %}
              0
            {% endif %}
          {% endif %}
        attributes:
          hours_until_night: >
            {% set night_start_str = states('input_datetime.night_mode_start_time') %}
            {% if night_start_str in ['unknown', 'unavailable'] %}
              0
            {% else %}
              {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
              {% set night_hour = night_start.hour + night_start.minute / 60 %}
              {% set current_hour = now().hour + now().minute / 60 %}
              {% if night_hour > current_hour %}
                {{ (night_hour - current_hour)|round(1) }}
              {% else %}
                {{ (24 - current_hour + night_hour)|round(1) }}
              {% endif %}
            {% endif %}
          estimated_discharge_kwh: >
            {% set night_start_str = states('input_datetime.night_mode_start_time') %}
            {% if night_start_str in ['unknown', 'unavailable'] %}
              0
            {% else %}
              {% set night_start = strptime(night_start_str, '%H:%M:%S') %}
              {% set night_hour = night_start.hour + night_start.minute / 60 %}
              {% set current_hour = now().hour + now().minute / 60 %}
              {% if night_hour > current_hour %}
                {% set hours_until = night_hour - current_hour %}
              {% else %}
                {% set hours_until = 24 - current_hour + night_hour %}
              {% endif %}
              {% set current_discharge = states('sensor.marstek_system_total_grid_power_2')|float(0) %}
              {{ ((current_discharge / 1000) * hours_until)|round(2) if current_discharge > 0 else 0 }}
            {% endif %}

      - name: "Marstek Expected PV Tomorrow"
        unique_id: marstek_expected_pv_tomorrow
        unit_of_measurement: "kWh"
        icon: mdi:solar-power-variant
        state: >
          {% set sunny_hours = states('sensor.marstek_sunny_hours_tomorrow')|float(0) %}
          {% set kwh_per_hour = states('input_number.pv_production_per_sunny_hour')|float(1.5) %}
          {{ (sunny_hours * kwh_per_hour)|round(1) }}

      - name: "Marstek Net Charging Deficit"
        unique_id: marstek_net_charging_deficit
        unit_of_measurement: "kWh"
        icon: mdi:battery-charging-outline
        state: >
          {% set deficit = states('sensor.marstek_capacity_deficit')|float(0) %}
          {% set expected_pv = states('sensor.marstek_expected_pv_tomorrow')|float(0) %}
          {{ [0, deficit - expected_pv]|max|round(2) }}

      # Piekbewust laden - veilig om te laden?
      - name: "Marstek Safe To Charge"
        unique_id: marstek_safe_to_charge
        icon: mdi:shield-check
        state: >
          {% set avg = states('sensor.p1_meter_average_demand')|float(0) %}
          {% set power = states('input_number.night_charging_power')|float(2000) %}
          {% set peak = states('sensor.p1_meter_peak_demand_current_month')|float(2500) %}
          {{ (avg + power) < peak }}
        attributes:
          current_avg: "{{ states('sensor.p1_meter_average_demand')|float(0)|round(0) }}"
          charging_power: "{{ states('input_number.night_charging_power')|float(2000)|round(0) }}"
          monthly_peak: "{{ states('sensor.p1_meter_peak_demand_current_month')|float(2500)|round(0) }}"
          headroom: >
            {% set avg = states('sensor.p1_meter_average_demand')|float(0) %}
            {% set peak = states('sensor.p1_meter_peak_demand_current_month')|float(2500) %}
            {{ (peak - avg)|round(0) }}

      - name: "Marstek Charging Plan"
        unique_id: marstek_charging_plan
        icon: mdi:battery-charging-wireless
        state: >
          {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
          {% set cap_b = states('sensor.marstek_fase_b_remaining_capacity')|float(5) %}
          {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
          {% set avail_a = [5 - cap_a, 0]|max %}
          {% set avail_b = [5 - cap_b, 0]|max %}
          {% set avail_c = [5 - cap_c, 0]|max %}
          {% set bats = [
            {'name': 'A', 'avail': avail_a},
            {'name': 'B', 'avail': avail_b},
            {'name': 'C', 'avail': avail_c}
          ] %}
          {% set sorted_bats = bats | sort(attribute='avail', reverse=true) | list %}
          {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
          {% set hours = states('sensor.marstek_night_hours')|float(6) %}
          {% set ns = namespace(remaining=deficit, parts=[]) %}
          {% for bat in sorted_bats %}
            {% set charge = [ns.remaining, bat.avail]|min %}
            {% if charge > 0.1 %}
              {% set power = [((charge / hours) * 1000)|int, 2500]|min %}
              {% set ns.parts = ns.parts + [bat.name ~ ':' ~ charge|round(1) ~ 'kWh@' ~ power ~ 'W'] %}
            {% endif %}
            {% set ns.remaining = [ns.remaining - charge, 0]|max %}
          {% endfor %}
          {{ ns.parts | join(' | ') if ns.parts else 'Geen laden nodig' }}
        attributes:
          fase_a_charge: >
            {% set cap = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_fase_b_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}
          fase_b_charge: >
            {% set cap = states('sensor.marstek_fase_b_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_fase_b_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}
          fase_c_charge: >
            {% set cap = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
            {% set avail = [5 - cap, 0]|max %}
            {% set deficit = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set all_avail = [
              [5 - states('sensor.marstek_venuse_d828_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_fase_b_remaining_capacity')|float(5), 0]|max,
              [5 - states('sensor.marstek_venuse_remaining_capacity')|float(5), 0]|max
            ] | sort(reverse=true) %}
            {% set my_rank = 0 if avail == all_avail[0] else (1 if avail == all_avail[1] else 2) %}
            {% set before_me = all_avail[:my_rank] | sum %}
            {% set remaining_for_me = [deficit - before_me, 0]|max %}
            {{ [remaining_for_me, avail]|min|round(2) }}

  # Trigger-based sensor voor zonuren morgen (update elk uur vanaf 17:00)
  - trigger:
      - platform: time
        at:
          - "17:00:00"
          - "18:00:00"
          - "19:00:00"
          - "20:00:00"
          - "21:00:00"
          - "22:00:00"
          - "23:00:00"
      - platform: homeassistant
        event: start
    action:
      - service: weather.get_forecasts
        data:
          type: hourly
        target:
          entity_id: weather.forecast_home
        response_variable: forecast
    sensor:
      - name: "Marstek Sunny Hours Tomorrow"
        unique_id: marstek_sunny_hours_tomorrow
        unit_of_measurement: "h"
        icon: mdi:weather-sunny
        state: >
          {% set tomorrow = (now() + timedelta(days=1)).date() %}
          {% set forecasts = forecast['weather.forecast_home']['forecast'] | default([]) %}
          {% set sunny_count = namespace(count=0) %}
          {% for f in forecasts %}
            {% set forecast_date = as_datetime(f.datetime).date() %}
            {% set forecast_hour = as_datetime(f.datetime).hour %}
            {% if forecast_date == tomorrow and forecast_hour >= 7 and forecast_hour <= 20 %}
              {% if f.condition == 'sunny' %}
                {% set sunny_count.count = sunny_count.count + 1 %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ sunny_count.count }}
        attributes:
          last_update: "{{ now().isoformat() }}"
          forecast_date: "{{ (now() + timedelta(days=1)).date() }}"

# ============================================================================
# INPUT HELPERS
# Tracking en configuratie
# ============================================================================
input_text:
  active_battery_fase:
    name: "Actieve Batterij Fase"
    initial: "fase_a"
    icon: mdi:battery-charging

  overflow_battery_fase:
    name: "Overflow Batterij Fase"
    initial: ""
    icon: mdi:battery-plus-variant

  peak_assist_battery_fase:
    name: "Peak Assist Batterij Fase"
    initial: ""
    icon: mdi:battery-arrow-down

  night_charging_current_battery:
    name: "Huidige Laadbatterij"
    initial: ""
    icon: mdi:battery-arrow-up

input_select:
  dashboard_tab:
    name: "Dashboard Sectie"
    options:
      - "Status"
      - "Nachtladen"
      - "Besturing"
      - "Instellingen"
      - "Logboek"
    initial: "Status"
    icon: mdi:view-dashboard

  night_charging_mode:
    name: "Nachtladen Modus"
    options:
      - "Manueel Schema"
      - "Piekbewust Laden"
    initial: "Manueel Schema"
    icon: mdi:battery-charging-wireless

input_number:
  battery_switch_delay_minutes:
    name: "Minimale Tijd Tussen Switches"
    min: 1
    max: 30
    step: 1
    initial: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand

  desired_total_capacity:
    name: "Gewenste Capaciteit bij Dagstart"
    min: 0
    max: 15
    step: 0.5
    initial: 10
    unit_of_measurement: "kWh"
    icon: mdi:battery-charging-high

  pv_production_per_sunny_hour:
    name: "PV Productie per Zonuur"
    min: 0
    max: 5
    step: 0.1
    initial: 1.5
    unit_of_measurement: "kWh"
    icon: mdi:solar-power

  overflow_power:
    name: "Overflow Laadvermogen"
    min: 100
    max: 2500
    step: 100
    initial: 1500
    unit_of_measurement: "W"
    icon: mdi:flash

  overflow_duration:
    name: "Overflow Duur"
    min: 5
    max: 60
    step: 5
    initial: 30
    unit_of_measurement: "min"
    icon: mdi:timer

  peak_assist_power:
    name: "Peak Assist Ontlaadvermogen"
    min: 100
    max: 2500
    step: 100
    initial: 1000
    unit_of_measurement: "W"
    icon: mdi:flash

  peak_assist_duration:
    name: "Peak Assist Duur"
    min: 1
    max: 60
    step: 1
    initial: 5
    unit_of_measurement: "min"
    icon: mdi:timer

  night_charging_power:
    name: "Nachtladen Vermogen"
    min: 500
    max: 2500
    step: 100
    initial: 2000
    unit_of_measurement: "W"
    icon: mdi:flash

input_datetime:
  last_battery_switch:
    name: "Laatste Batterij Switch"
    has_date: true
    has_time: true
    icon: mdi:clock-outline

  night_mode_start_time:
    name: "Nachtmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-night

  day_mode_start_time:
    name: "Dagmodus Start"
    has_date: false
    has_time: true
    icon: mdi:weather-sunny

input_boolean:
  battery_rotation_enabled:
    name: "Batterij Rotatie Systeem"
    initial: true
    icon: mdi:autorenew

  night_charging_active:
    name: "Piekbewust Laden Actief"
    initial: false
    icon: mdi:battery-charging-wireless

timer:
  overflow_charging_timer:
    name: "Overflow Charging Timer"
    icon: mdi:timer-outline

  peak_assist_timer:
    name: "Peak Assist Timer"
    icon: mdi:timer-outline

# ============================================================================
# AUTOMATIONS
# ============================================================================
automation:
  # --------------------------------------------------------------------------
  # MANUAL TOGGLE OFF - Alle batterijen naar Manual
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_off
    alias: "Marstek: Manual Toggle OFF"
    description: "Wanneer rotatie manueel uitgezet wordt, alle batterijen naar Manual"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "off"
    action:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      - service: notify.persistent_notification
        data:
          title: "üî¥ Marstek - Rotatie UIT"
          message: "Alle batterijen op Manual mode"

  # --------------------------------------------------------------------------
  # MANUAL TOGGLE ON - Volste batterij naar Auto
  # --------------------------------------------------------------------------
  - id: marstek_manual_toggle_on
    alias: "Marstek: Manual Toggle ON"
    description: "Wanneer rotatie manueel aangezet wordt, volste batterij naar Auto"
    trigger:
      - platform: state
        entity_id: input_boolean.battery_rotation_enabled
        to: "on"
    action:
      - variables:
          fullest: "{{ states('sensor.battery_fullest') }}"

      # Activeer volste batterij
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ fullest }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      - service: notify.persistent_notification
        data:
          title: "üü¢ Marstek - Rotatie AAN"
          message: >
            Volste batterij geactiveerd: {{ fullest | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}

  # --------------------------------------------------------------------------
  # SOLAR EXCESS - Switch naar leegste batterij
  # --------------------------------------------------------------------------
  - id: marstek_solar_excess_switch
    alias: "Marstek: Solar Excess - Switch to Emptiest"
    description: "Bij zonoverschot EN bijna volle batterij: switch naar leegste batterij"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        below: -200  # Teruglevering > 200W (negatief = teruglevering)
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != leegste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_emptiest') }}

      # Actieve batterij SOC >= 85% (bijna vol) - anders overflow charging
      - condition: template
        value_template: >
          {% set active = states('input_text.active_battery_fase') %}
          {% if active == 'fase_a' %}
            {{ states('sensor.marstek_venuse_d828_state_of_charge')|float(0) >= 85 }}
          {% elif active == 'fase_b' %}
            {{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0) >= 85 }}
          {% else %}
            {{ states('sensor.marstek_venuse_state_of_charge')|float(0) >= 85 }}
          {% endif %}

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Zonoverschot"
          message: >
            Teruglevering: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_emptiest', 'label') }} ({{ state_attr('sensor.battery_emptiest', 'soc') }}% SOC)

      # Eerst leegste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_emptiest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_emptiest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # GRID CONSUMPTION - Switch naar volste batterij
  # --------------------------------------------------------------------------
  - id: marstek_grid_consumption_switch
    alias: "Marstek: Grid Consumption - Switch to Fullest"
    description: "Bij netverbruik: switch naar volste batterij om te ontladen"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        above: 200  # Verbruik > 200W
        for:
          minutes: 2  # Moet 2 minuten aanhouden
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Minimale tijd tussen switches
      - condition: template
        value_template: >
          {{ (as_timestamp(now()) - as_timestamp(states('input_datetime.last_battery_switch'))) > (states('input_number.battery_switch_delay_minutes')|float(5) * 60) }}

      # Actieve batterij != volste batterij
      - condition: template
        value_template: >
          {{ states('input_text.active_battery_fase') != states('sensor.battery_fullest') }}

      # Geen peak assist actief (conflict preventie)
      - condition: template
        value_template: "{{ states('input_text.peak_assist_battery_fase') in ['', 'unknown', 'unavailable'] }}"

    action:
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Netverbruik"
          message: >
            Verbruik: {{ states('sensor.p1_meter_power') }}W
            Switch van {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }}
            naar {{ state_attr('sensor.battery_fullest', 'label') }} ({{ state_attr('sensor.battery_fullest', 'soc') }}% SOC)

      # Eerst volste batterij activeren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_auto_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_auto_mode
                continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Dan pas andere batterijen deactiveren
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.faseb_plat_v3_9a7d_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.fasec_geen_deb8_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ states('sensor.battery_fullest') == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id:
                    - button.fasea_schuin_d828_manual_mode
                    - button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "{{ states('sensor.battery_fullest') }}"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

  # --------------------------------------------------------------------------
  # NIGHT MODE - Multi-batterij nachtladen (Manueel Schema)
  # --------------------------------------------------------------------------
  - id: marstek_night_charging
    alias: "Marstek: Night Charging (Manual Schedule)"
    description: "Laad batterijen via manueel schema - verdeelt deficit over meerdere batterijen"
    trigger:
      - platform: time
        at: input_datetime.night_mode_start_time
    condition:
      - condition: state
        entity_id: input_select.night_charging_mode
        state: "Manueel Schema"
    action:
      # Notificatie: oude schedules worden gewist
      - service: notify.persistent_notification
        data:
          title: "üåô Marstek - Nachtmodus Voorbereiding"
          message: "Oude manual schedules worden gewist voor clean start..."

      # Clear oude manual schedules van alle batterijen
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"  # Fase A
        continue_on_error: true

      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"  # Fase B
        continue_on_error: true

      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"  # Fase C
        continue_on_error: true

      # Wacht tot clear compleet is (traag process)
      - delay:
          seconds: 5

      # Logbook entry
      - service: logbook.log
        data:
          name: "Night Charging"
          message: "Manual schedules gewist voor clean start"
          entity_id: input_boolean.battery_rotation_enabled

      # Zet rotatie systeem UIT
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Bereken laadplan - verdeelt deficit over batterijen (leegste eerst)
      - variables:
          deficit: "{{ states('sensor.marstek_capacity_deficit')|float(0) }}"
          expected_pv: "{{ states('sensor.marstek_expected_pv_tomorrow')|float(0) }}"
          net_deficit: "{{ states('sensor.marstek_net_charging_deficit')|float(0) }}"
          sunny_hours: "{{ states('sensor.marstek_sunny_hours_tomorrow')|int(0) }}"
          night_hours: "{{ states('sensor.marstek_night_hours')|float(6) }}"
          night_end: "{{ states('input_datetime.day_mode_start_time')[:5] }}"
          night_start: "{{ states('input_datetime.night_mode_start_time')[:5] }}"
          max_power: 2500

          # Bereken laadplan per batterij
          charging_plan: >
            {% set cap_a = states('sensor.marstek_venuse_d828_remaining_capacity')|float(5) %}
            {% set cap_b = states('sensor.marstek_fase_b_remaining_capacity')|float(5) %}
            {% set cap_c = states('sensor.marstek_venuse_remaining_capacity')|float(5) %}
            {% set avail_a = [5 - cap_a, 0]|max %}
            {% set avail_b = [5 - cap_b, 0]|max %}
            {% set avail_c = [5 - cap_c, 0]|max %}
            {% set bats = [
              {'id': 'a', 'name': 'Fase A', 'avail': avail_a, 'device_id': 'c1fbfff25b11fcecf3530135b0b08f2c'},
              {'id': 'b', 'name': 'Fase B', 'avail': avail_b, 'device_id': '79ea26ebcb0b77cc1e4acd1cc5af41f6'},
              {'id': 'c', 'name': 'Fase C', 'avail': avail_c, 'device_id': 'f15b9f6024d9a2b044ca90e77824a314'}
            ] %}
            {% set sorted_bats = bats | sort(attribute='avail', reverse=true) | list %}
            {% set deficit_val = states('sensor.marstek_net_charging_deficit')|float(0) %}
            {% set hours = states('sensor.marstek_night_hours')|float(6) %}
            {% set ns = namespace(remaining=deficit_val, result=[]) %}
            {% for bat in sorted_bats %}
              {% set charge = [ns.remaining, bat.avail]|min %}
              {% set power = [((charge / hours) * 1000)|int, 2500]|min if charge > 0.1 else 0 %}
              {% set ns.remaining = [ns.remaining - charge, 0]|max %}
              {% set ns.result = ns.result + [{'name': bat.name, 'device_id': bat.device_id, 'charge': charge|round(2), 'power': power}] %}
            {% endfor %}
            {{ ns.result }}

      # Als netto deficit > 0: laad batterijen volgens plan
      - if:
          - condition: template
            value_template: "{{ net_deficit > 0 }}"
        then:
          # Batterij 1 (meeste ruimte/leegst)
          - if:
              - condition: template
                value_template: "{{ charging_plan[0].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[0].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[0].power }}"
                  enabled: true
                continue_on_error: true

          # Batterij 2
          - if:
              - condition: template
                value_template: "{{ charging_plan[1].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[1].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[1].power }}"
                  enabled: true
                continue_on_error: true

          # Batterij 3
          - if:
              - condition: template
                value_template: "{{ charging_plan[2].power > 0 }}"
            then:
              - service: marstek_local_api.set_manual_schedule
                data:
                  device_id: "{{ charging_plan[2].device_id }}"
                  time_num: 0
                  start_time: "{{ night_start }}"
                  end_time: "{{ night_end }}"
                  power: "{{ -charging_plan[2].power }}"
                  enabled: true
                continue_on_error: true

          # Notificatie met laadinfo per batterij
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtladen"
              message: >
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Netto te laden: {{ net_deficit }} kWh

                {% for bat in charging_plan if bat.power > 0 %}
                {{ bat.name }}: {{ bat.charge }} kWh @ {{ bat.power }}W
                {% endfor %}
                Periode: {{ night_start }} - {{ night_end }}

        # Geen netto deficit: alles naar Manual
        else:
          - service: button.press
            target:
              entity_id:
                - button.fasea_schuin_d828_manual_mode
                - button.faseb_plat_v3_9a7d_manual_mode
                - button.fasec_geen_deb8_manual_mode
            continue_on_error: true

          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Nachtmodus"
              message: >
                Geen nachtladen nodig.
                Deficit: {{ deficit }} kWh - PV morgen: {{ expected_pv }} kWh ({{ sunny_hours }}h zon)
                Alle batterijen op Manual.

  # --------------------------------------------------------------------------
  # MORNING MODE - Enable rotatie en start Fase A
  # --------------------------------------------------------------------------
  - id: marstek_enable_rotation_in_morning
    alias: "Marstek: Enable Rotation in Morning"
    description: "Zet batterij rotatie AAN, activeer Fase A, daarna clear nachtschema's"
    trigger:
      - platform: time
        at: input_datetime.day_mode_start_time
    action:
      # EERST: Zet rotatie systeem AAN (directe feedback)
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Activeer Fase A
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true

      # Wacht op stabilisatie
      - delay:
          seconds: 5

      # Deactiveer andere batterijen
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"

      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚òÄÔ∏è Marstek - Dagmodus"
          message: "Batterij rotatie AAN - Fase A geactiveerd"

      # Reset piekbewust laden tracking
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.night_charging_active
      - service: input_text.set_value
        target:
          entity_id: input_text.night_charging_current_battery
        data:
          value: ""

      # LAATST: Clear nacht laadschema's (traag, minder urgent)
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
        continue_on_error: true
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"
        continue_on_error: true

  # --------------------------------------------------------------------------
  # OVERFLOW CHARGING - Tweede batterij laden bij hoge PV productie
  # --------------------------------------------------------------------------
  - id: marstek_overflow_charging_start
    alias: "Marstek: Overflow Charging Start"
    description: "Bij hoge PV productie en niet-volle batterij, activeer tweede batterij in Passive mode"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        below: -200
        for:
          minutes: 1
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Geen overflow al actief
      - condition: template
        value_template: "{{ states('input_text.overflow_battery_fase') in ['', 'unknown', 'unavailable'] }}"

      # Actieve batterij SOC < 85% (niet bijna vol, dus niet switchen maar overflow)
      - condition: template
        value_template: >
          {% set active = states('input_text.active_battery_fase') %}
          {% if active == 'fase_a' %}
            {{ states('sensor.marstek_venuse_d828_state_of_charge')|float(100) < 85 }}
          {% elif active == 'fase_b' %}
            {{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100) < 85 }}
          {% else %}
            {{ states('sensor.marstek_venuse_state_of_charge')|float(100) < 85 }}
          {% endif %}

      # Geen peak assist actief (conflict preventie)
      - condition: template
        value_template: "{{ states('input_text.peak_assist_battery_fase') in ['', 'unknown', 'unavailable'] }}"

    action:
      - variables:
          # Bereken power: |P1| met max van instelling
          max_power: "{{ states('input_number.overflow_power')|int(1500) }}"
          overflow_power: "{{ [states('sensor.p1_meter_power')|float(0)|abs|int, max_power]|min }}"
          duration_sec: "{{ states('input_number.overflow_duration')|int(30) * 60 }}"
          active: "{{ states('input_text.active_battery_fase') }}"
          # Bepaal leegste inactieve batterij
          emptiest_inactive: >
            {% set socs = {
              'fase_a': states('sensor.marstek_venuse_d828_state_of_charge')|float(100),
              'fase_b': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100),
              'fase_c': states('sensor.marstek_venuse_state_of_charge')|float(100)
            } %}
            {% set inactive = socs | dictsort(by='value') | rejectattr('0', 'eq', active) | list %}
            {{ inactive[0][0] if inactive else 'fase_a' }}

      # Zet overflow batterij in Passive mode
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ emptiest_inactive == 'fase_a' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                  power: "{{ -overflow_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ emptiest_inactive == 'fase_b' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                  power: "{{ -overflow_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ emptiest_inactive == 'fase_c' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "f15b9f6024d9a2b044ca90e77824a314"
                  power: "{{ -overflow_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

      # Track welke batterij in overflow is
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: "{{ emptiest_inactive }}"

      # Start timer voor automatische cleanup
      - service: timer.start
        target:
          entity_id: timer.overflow_charging_timer
        data:
          duration: "{{ duration_sec }}"

      # Logbook entry voor Recente Activiteit
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: >
            {{ emptiest_inactive | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            gestart @ {{ overflow_power }}W (PV: {{ states('sensor.p1_meter_power')|abs }}W)
          entity_id: input_text.overflow_battery_fase

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Charging"
          message: >
            PV overflow: {{ states('sensor.p1_meter_power')|abs }}W
            {{ emptiest_inactive | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            in Passive mode @ {{ overflow_power }}W voor {{ duration_sec // 60 }} min

  # --------------------------------------------------------------------------
  # OVERFLOW CHARGING STOP - Terug naar normaal bij verbruik
  # --------------------------------------------------------------------------
  - id: marstek_overflow_charging_stop
    alias: "Marstek: Overflow Charging Stop"
    description: "Stop overflow charging wanneer P1 positief wordt (verbruik)"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        above: 100
        for:
          minutes: 1
    condition:
      # Er is een overflow batterij actief
      - condition: template
        value_template: "{{ states('input_text.overflow_battery_fase') not in ['', 'unknown', 'unavailable'] }}"

    action:
      - variables:
          overflow_bat: "{{ states('input_text.overflow_battery_fase') }}"

      # Zet overflow batterij terug naar Manual
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true

      # Clear overflow tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: ""

      # Cancel timer (overflow gestopt door verbruik)
      - service: timer.cancel
        target:
          entity_id: timer.overflow_charging_timer

      # Logbook entry voor Recente Activiteit
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: >
            {{ overflow_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            gestopt (verbruik: {{ states('sensor.p1_meter_power') }}W)
          entity_id: input_text.overflow_battery_fase

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Gestopt"
          message: >
            Verbruik gedetecteerd ({{ states('sensor.p1_meter_power') }}W)
            {{ overflow_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            terug naar Manual mode

  # --------------------------------------------------------------------------
  # OVERFLOW CHARGING TIMER - Automatische cleanup na duration
  # --------------------------------------------------------------------------
  - id: marstek_overflow_charging_timer_finished
    alias: "Marstek: Overflow Charging Timer Finished"
    description: "Zet batterij terug naar Manual wanneer overflow duration afloopt"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.overflow_charging_timer
    condition:
      # Check of overflow tracking nog actief is
      - condition: template
        value_template: "{{ states('input_text.overflow_battery_fase') not in ['', 'unknown', 'unavailable'] }}"
    action:
      - variables:
          overflow_bat: "{{ states('input_text.overflow_battery_fase') }}"

      # Zet overflow batterij terug naar Manual
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true

      # Clear overflow tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: ""

      # Logbook entry
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: >
            {{ overflow_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            voltooid (timer)
          entity_id: input_text.overflow_battery_fase

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Voltooid"
          message: >
            {{ overflow_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            overflow charging voltooid - terug naar Manual mode

  # --------------------------------------------------------------------------
  # PEAK ASSIST - Tijdelijk bijleveren bij korte verbruikspieken
  # --------------------------------------------------------------------------
  - id: marstek_peak_assist_start
    alias: "Marstek: Peak Assist Start"
    description: "Bij korte verbruikspiek, activeer volste batterij tijdelijk in Passive mode om bij te leveren"
    trigger:
      - platform: numeric_state
        entity_id: sensor.p1_meter_power
        above: 200
        for:
          seconds: 20
    condition:
      # Systeem enabled
      - condition: state
        entity_id: input_boolean.battery_rotation_enabled
        state: "on"

      # Alleen in dagfase (niet 's nachts)
      - condition: template
        value_template: >
          {% set now_time = now().time() %}
          {% set day_start = states('input_datetime.day_mode_start_time') %}
          {% set night_start = states('input_datetime.night_mode_start_time') %}
          {% if day_start not in ['unknown', 'unavailable'] and night_start not in ['unknown', 'unavailable'] %}
            {% set day_h = day_start.split(':')[0]|int %}
            {% set day_m = day_start.split(':')[1]|int %}
            {% set night_h = night_start.split(':')[0]|int %}
            {% set night_m = night_start.split(':')[1]|int %}
            {% set day_minutes = day_h * 60 + day_m %}
            {% set night_minutes = night_h * 60 + night_m %}
            {% set now_minutes = now_time.hour * 60 + now_time.minute %}
            {% if day_minutes < night_minutes %}
              {{ now_minutes >= day_minutes and now_minutes < night_minutes }}
            {% else %}
              {{ now_minutes >= day_minutes or now_minutes < night_minutes }}
            {% endif %}
          {% else %}
            true
          {% endif %}

      # Geen peak assist al actief
      - condition: template
        value_template: "{{ states('input_text.peak_assist_battery_fase') in ['', 'unknown', 'unavailable'] }}"

      # Geen overflow charging actief (conflict preventie)
      - condition: template
        value_template: "{{ states('input_text.overflow_battery_fase') in ['', 'unknown', 'unavailable'] }}"

    action:
      - variables:
          assist_power: "{{ states('input_number.peak_assist_power')|int(1000) }}"
          duration_sec: "{{ states('input_number.peak_assist_duration')|int(5) * 60 }}"
          active: "{{ states('input_text.active_battery_fase') }}"
          # Bepaal volste inactieve batterij
          fullest_inactive: >
            {% set socs = {
              'fase_a': states('sensor.marstek_venuse_d828_state_of_charge')|float(0),
              'fase_b': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0),
              'fase_c': states('sensor.marstek_venuse_state_of_charge')|float(0)
            } %}
            {% set inactive = socs | dictsort(by='value', reverse=true) | rejectattr('0', 'eq', active) | list %}
            {{ inactive[0][0] if inactive else 'fase_a' }}

      # Zet peak assist batterij in Passive mode (positief = ontladen)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ fullest_inactive == 'fase_a' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                  power: "{{ assist_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest_inactive == 'fase_b' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                  power: "{{ assist_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ fullest_inactive == 'fase_c' }}"
            sequence:
              - service: marstek_local_api.set_passive_mode
                data:
                  device_id: "f15b9f6024d9a2b044ca90e77824a314"
                  power: "{{ assist_power }}"
                  duration: "{{ duration_sec }}"
                continue_on_error: true

      # Track welke batterij in peak assist is
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: "{{ fullest_inactive }}"

      # Start timer voor automatische cleanup
      - service: timer.start
        target:
          entity_id: timer.peak_assist_timer
        data:
          duration: "{{ duration_sec }}"

      # Logbook entry
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: >
            {{ fullest_inactive | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            gestart: {{ assist_power }}W voor {{ duration_sec // 60 }} minuten
          entity_id: input_text.peak_assist_battery_fase

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Gestart"
          message: >
            {{ fullest_inactive | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            levert {{ assist_power }}W bij voor {{ duration_sec // 60 }} minuten

  - id: marstek_peak_assist_timer_finished
    alias: "Marstek: Peak Assist Timer Finished"
    description: "Zet batterij terug naar Manual wanneer peak assist duration afloopt"
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.peak_assist_timer
    condition:
      # Check of peak assist tracking nog actief is
      - condition: template
        value_template: "{{ states('input_text.peak_assist_battery_fase') not in ['', 'unknown', 'unavailable'] }}"
    action:
      - variables:
          assist_bat: "{{ states('input_text.peak_assist_battery_fase') }}"

      # Zet peak assist batterij terug naar Manual
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true

      # Clear peak assist tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: ""

      # Logbook entry
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: >
            {{ assist_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            voltooid (timer)
          entity_id: input_text.peak_assist_battery_fase

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Voltooid"
          message: >
            {{ assist_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
            peak assist voltooid - terug naar Manual mode

  # --------------------------------------------------------------------------
  # PIEKBEWUST NACHTLADEN - Start bij nachtmodus
  # --------------------------------------------------------------------------
  - id: marstek_night_charging_peakaware_start
    alias: "Marstek: Peak-Aware Night Charging Start"
    description: "Start piekbewust laden bij nachtmodus - laadt leegste batterij in passive mode"
    trigger:
      - platform: time
        at: input_datetime.night_mode_start_time
    condition:
      - condition: state
        entity_id: input_select.night_charging_mode
        state: "Piekbewust Laden"
    action:
      # Clear oude manual schedules EERST (voor clean start)
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"  # Fase A
        continue_on_error: true

      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"  # Fase B
        continue_on_error: true

      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"  # Fase C
        continue_on_error: true

      # Wacht tot clear compleet is
      - delay:
          seconds: 3

      # Logbook entry
      - service: logbook.log
        data:
          name: "Night Charging"
          message: "Manual schedules gewist - piekbewust laden start"
          entity_id: input_boolean.battery_rotation_enabled

      # Zet rotatie systeem UIT
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.battery_rotation_enabled

      # Alle batterijen naar manual (clean slate)
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true

      # Bepaal leegste batterij
      - variables:
          emptiest: "{{ states('sensor.battery_emptiest') }}"
          power_w: "{{ states('input_number.night_charging_power')|int(2000) }}"

      # Track huidige laadbatterij
      - service: input_text.set_value
        target:
          entity_id: input_text.night_charging_current_battery
        data:
          value: "{{ emptiest }}"

      # Check of safe to charge
      - if:
          - condition: state
            entity_id: sensor.marstek_safe_to_charge
            state: "True"
        then:
          # Start laden van leegste batterij
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_a' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_b' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

              - conditions:
                  - condition: template
                    value_template: "{{ emptiest == 'fase_c' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "f15b9f6024d9a2b044ca90e77824a314"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

          # Zet tracking aan
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.night_charging_active

          # Notificatie
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Piekbewust Laden Gestart"
              message: >
                {{ emptiest | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
                laden @ {{ power_w }}W
                Headroom: {{ state_attr('sensor.marstek_safe_to_charge', 'headroom') }}W

        else:
          # Niet veilig om te starten, wacht op lagere piek
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Piekbewust Wacht"
              message: >
                Laden uitgesteld - piekgrens zou overschreden worden
                Huidig gemiddelde: {{ state_attr('sensor.marstek_safe_to_charge', 'current_avg') }}W
                Maandpiek: {{ state_attr('sensor.marstek_safe_to_charge', 'monthly_peak') }}W

  # --------------------------------------------------------------------------
  # PIEKBEWUST NACHTLADEN - Pauzeer bij hoog verbruik
  # --------------------------------------------------------------------------
  - id: marstek_night_charging_peakaware_pause
    alias: "Marstek: Peak-Aware Night Charging Pause"
    description: "Pauzeer laden als piekgrens dreigt overschreden te worden"
    trigger:
      - platform: state
        entity_id: sensor.marstek_safe_to_charge
        to: "False"
    condition:
      # Piekbewust laden is actief
      - condition: state
        entity_id: input_boolean.night_charging_active
        state: "on"
    action:
      - variables:
          current_bat: "{{ states('input_text.night_charging_current_battery') }}"

      # Stop huidige laadbatterij
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true

      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "‚ö†Ô∏è Marstek - Laden Gepauzeerd"
          message: >
            Piekgrens dreigt overschreden - laden gepauzeerd
            Huidig gemiddelde: {{ state_attr('sensor.marstek_safe_to_charge', 'current_avg') }}W

  # --------------------------------------------------------------------------
  # PIEKBEWUST NACHTLADEN - Hervat bij laag verbruik
  # --------------------------------------------------------------------------
  - id: marstek_night_charging_peakaware_resume
    alias: "Marstek: Peak-Aware Night Charging Resume"
    description: "Hervat laden wanneer piekgrens weer ruimte geeft"
    trigger:
      - platform: state
        entity_id: sensor.marstek_safe_to_charge
        to: "True"
    condition:
      # We zijn in nachtmodus (tussen night start en day start)
      - condition: time
        after: input_datetime.night_mode_start_time
        before: input_datetime.day_mode_start_time
      # Piekbewust modus geselecteerd
      - condition: state
        entity_id: input_select.night_charging_mode
        state: "Piekbewust Laden"
      # Er is een batterij geselecteerd om te laden
      - condition: template
        value_template: "{{ states('input_text.night_charging_current_battery') not in ['', 'unknown', 'unavailable'] }}"
    action:
      - variables:
          current_bat: "{{ states('input_text.night_charging_current_battery') }}"
          power_w: "{{ states('input_number.night_charging_power')|int(2000) }}"

      # Check of huidige batterij niet vol is (< 95%)
      - if:
          - condition: template
            value_template: >
              {% if current_bat == 'fase_a' %}
                {{ states('sensor.marstek_venuse_d828_state_of_charge')|float(100) < 95 }}
              {% elif current_bat == 'fase_b' %}
                {{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100) < 95 }}
              {% else %}
                {{ states('sensor.marstek_venuse_state_of_charge')|float(100) < 95 }}
              {% endif %}
        then:
          # Hervat laden
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ current_bat == 'fase_a' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

              - conditions:
                  - condition: template
                    value_template: "{{ current_bat == 'fase_b' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

              - conditions:
                  - condition: template
                    value_template: "{{ current_bat == 'fase_c' }}"
                sequence:
                  - service: marstek_local_api.set_passive_mode
                    data:
                      device_id: "f15b9f6024d9a2b044ca90e77824a314"
                      power: "{{ -power_w }}"
                      duration: 3600
                    continue_on_error: true

          # Zet tracking aan
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.night_charging_active

          # Notificatie
          - service: notify.persistent_notification
            data:
              title: "üåô Marstek - Laden Hervat"
              message: >
                {{ current_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }}
                laden hervat @ {{ power_w }}W

  # --------------------------------------------------------------------------
  # PIEKBEWUST NACHTLADEN - Volgende batterij bij vol
  # --------------------------------------------------------------------------
  - id: marstek_night_charging_peakaware_next
    alias: "Marstek: Peak-Aware Night Charging Next Battery"
    description: "Schakel naar volgende batterij wanneer huidige vol is"
    trigger:
      # Check elke 5 minuten
      - platform: time_pattern
        minutes: "/5"
    condition:
      # Piekbewust laden actief
      - condition: state
        entity_id: input_boolean.night_charging_active
        state: "on"
      # Huidige batterij is vol (>= 95%)
      - condition: template
        value_template: >
          {% set current_bat = states('input_text.night_charging_current_battery') %}
          {% if current_bat == 'fase_a' %}
            {{ states('sensor.marstek_venuse_d828_state_of_charge')|float(0) >= 95 }}
          {% elif current_bat == 'fase_b' %}
            {{ states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(0) >= 95 }}
          {% elif current_bat == 'fase_c' %}
            {{ states('sensor.marstek_venuse_state_of_charge')|float(0) >= 95 }}
          {% else %}
            false
          {% endif %}
    action:
      - variables:
          current_bat: "{{ states('input_text.night_charging_current_battery') }}"
          power_w: "{{ states('input_number.night_charging_power')|int(2000) }}"
          # Vind volgende leegste batterij (exclusief huidige)
          next_bat: >
            {% set socs = {
              'fase_a': states('sensor.marstek_venuse_d828_state_of_charge')|float(100),
              'fase_b': states('sensor.marstek_venuse_3_0_9a7d_state_of_charge')|float(100),
              'fase_c': states('sensor.marstek_venuse_state_of_charge')|float(100)
            } %}
            {% set candidates = socs | dictsort(by='value') | rejectattr('0', 'eq', current_bat) | selectattr('1', 'lt', 95) | list %}
            {{ candidates[0][0] if candidates else '' }}

      # Stop huidige batterij
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true

          - conditions:
              - condition: template
                value_template: "{{ current_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true

      # Als er een volgende batterij is, start die
      - if:
          - condition: template
            value_template: "{{ next_bat != '' }}"
        then:
          # Update tracking
          - service: input_text.set_value
            target:
              entity_id: input_text.night_charging_current_battery
            data:
              value: "{{ next_bat }}"

          # Start volgende batterij (als safe to charge)
          - if:
              - condition: state
                entity_id: sensor.marstek_safe_to_charge
                state: "True"
            then:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ next_bat == 'fase_a' }}"
                    sequence:
                      - service: marstek_local_api.set_passive_mode
                        data:
                          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
                          power: "{{ -power_w }}"
                          duration: 3600
                        continue_on_error: true

                  - conditions:
                      - condition: template
                        value_template: "{{ next_bat == 'fase_b' }}"
                    sequence:
                      - service: marstek_local_api.set_passive_mode
                        data:
                          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
                          power: "{{ -power_w }}"
                          duration: 3600
                        continue_on_error: true

                  - conditions:
                      - condition: template
                        value_template: "{{ next_bat == 'fase_c' }}"
                    sequence:
                      - service: marstek_local_api.set_passive_mode
                        data:
                          device_id: "f15b9f6024d9a2b044ca90e77824a314"
                          power: "{{ -power_w }}"
                          duration: 3600
                        continue_on_error: true

          # Notificatie
          - service: notify.persistent_notification
            data:
              title: "üîã Marstek - Volgende Batterij"
              message: >
                {{ current_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }} vol
                ‚Üí {{ next_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }} gestart

        else:
          # Alle batterijen vol - stop piekbewust laden
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.night_charging_active
          - service: input_text.set_value
            target:
              entity_id: input_text.night_charging_current_battery
            data:
              value: ""
          - service: notify.persistent_notification
            data:
              title: "‚úÖ Marstek - Alle Batterijen Vol"
              message: "Piekbewust nachtladen voltooid - alle batterijen >= 95%"

# ============================================================================
# SCRIPTS
# Helper scripts voor manuele controle
# ============================================================================
script:
  # Switch naar specifieke batterij
  marstek_activate_fase_a:
    alias: "Activeer Fase A (schuin)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasea_schuin_d828_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_a"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase A (schuin) geactiveerd"

  marstek_activate_fase_b:
    alias: "Activeer Fase B (plat)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.faseb_plat_v3_9a7d_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_b"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase B (plat) geactiveerd"

  marstek_activate_fase_c:
    alias: "Activeer Fase C (geen)"
    sequence:
      # Eerst nieuwe batterij actief maken
      - service: button.press
        target:
          entity_id: button.fasec_geen_deb8_auto_mode
        continue_on_error: true
      # Wacht op stabilisatie
      - delay:
          seconds: 5
      # Dan pas andere batterijen deactiveren
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
        continue_on_error: true
      # Update tracking
      - service: input_text.set_value
        target:
          entity_id: input_text.active_battery_fase
        data:
          value: "fase_c"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_battery_switch
        data:
          datetime: "{{ now().isoformat() }}"
      # Notificatie
      - service: notify.persistent_notification
        data:
          title: "üîã Marstek - Manuele Switch"
          message: "Fase C (geen) geactiveerd"

  # Zet alle batterijen naar Auto (voor testen)
  marstek_all_batteries_auto:
    alias: "Alle Batterijen Auto Mode"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_auto_mode
            - button.faseb_plat_v3_9a7d_auto_mode
            - button.fasec_geen_deb8_auto_mode
        continue_on_error: true

  # Zet alle batterijen naar Manual (emergency stop)
  marstek_all_batteries_manual:
    alias: "Alle Batterijen Manual Mode (STOP)"
    sequence:
      - service: button.press
        target:
          entity_id:
            - button.fasea_schuin_d828_manual_mode
            - button.faseb_plat_v3_9a7d_manual_mode
            - button.fasec_geen_deb8_manual_mode
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: ""
      - service: notify.persistent_notification
        data:
          title: "üõë Marstek - Emergency Stop"
          message: "Alle batterijen gezet naar Manual mode"

  # Overflow charging scripts
  marstek_overflow_fase_a:
    alias: "Overflow Fase A"
    sequence:
      - variables:
          power_w: "{{ states('input_number.overflow_power')|int(1500) }}"
          duration_sec: "{{ states('input_number.overflow_duration')|int(30) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
          power: "{{ -power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: "fase_a"
      - service: timer.start
        target:
          entity_id: timer.overflow_charging_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: "Fase A handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.overflow_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Handmatig"
          message: "Fase A in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_overflow_fase_b:
    alias: "Overflow Fase B"
    sequence:
      - variables:
          power_w: "{{ states('input_number.overflow_power')|int(1500) }}"
          duration_sec: "{{ states('input_number.overflow_duration')|int(30) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
          power: "{{ -power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: "fase_b"
      - service: timer.start
        target:
          entity_id: timer.overflow_charging_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: "Fase B handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.overflow_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Handmatig"
          message: "Fase B in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_overflow_fase_c:
    alias: "Overflow Fase C"
    sequence:
      - variables:
          power_w: "{{ states('input_number.overflow_power')|int(1500) }}"
          duration_sec: "{{ states('input_number.overflow_duration')|int(30) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"
          power: "{{ -power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: "fase_c"
      - service: timer.start
        target:
          entity_id: timer.overflow_charging_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: "Fase C handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.overflow_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Handmatig"
          message: "Fase C in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_overflow_stop:
    alias: "Stop Overflow"
    sequence:
      - variables:
          overflow_bat: "{{ states('input_text.overflow_battery_fase') }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true
          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true
          - conditions:
              - condition: template
                value_template: "{{ overflow_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.overflow_battery_fase
        data:
          value: ""
      - service: timer.cancel
        target:
          entity_id: timer.overflow_charging_timer
      - service: logbook.log
        data:
          name: "Overflow Charging"
          message: "{{ overflow_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }} handmatig gestopt"
          entity_id: input_text.overflow_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Overflow Gestopt"
          message: "Overflow charging handmatig gestopt"

  # Peak assist scripts
  marstek_peak_assist_fase_a:
    alias: "Peak Assist Fase A"
    sequence:
      - variables:
          power_w: "{{ states('input_number.peak_assist_power')|int(1000) }}"
          duration_sec: "{{ states('input_number.peak_assist_duration')|int(5) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"
          power: "{{ power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: "fase_a"
      - service: timer.start
        target:
          entity_id: timer.peak_assist_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: "Fase A handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.peak_assist_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Handmatig"
          message: "Fase A in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_peak_assist_fase_b:
    alias: "Peak Assist Fase B"
    sequence:
      - variables:
          power_w: "{{ states('input_number.peak_assist_power')|int(1000) }}"
          duration_sec: "{{ states('input_number.peak_assist_duration')|int(5) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"
          power: "{{ power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: "fase_b"
      - service: timer.start
        target:
          entity_id: timer.peak_assist_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: "Fase B handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.peak_assist_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Handmatig"
          message: "Fase B in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_peak_assist_fase_c:
    alias: "Peak Assist Fase C"
    sequence:
      - variables:
          power_w: "{{ states('input_number.peak_assist_power')|int(1000) }}"
          duration_sec: "{{ states('input_number.peak_assist_duration')|int(5) * 60 }}"
      - service: marstek_local_api.set_passive_mode
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"
          power: "{{ power_w }}"
          duration: "{{ duration_sec }}"
        continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: "fase_c"
      - service: timer.start
        target:
          entity_id: timer.peak_assist_timer
        data:
          duration: "{{ duration_sec }}"
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: "Fase C handmatig gestart @ {{ power_w }}W"
          entity_id: input_text.peak_assist_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Handmatig"
          message: "Fase C in Passive mode @ {{ power_w }}W voor {{ duration_sec // 60 }} min"

  marstek_peak_assist_stop:
    alias: "Stop Peak Assist"
    sequence:
      - variables:
          assist_bat: "{{ states('input_text.peak_assist_battery_fase') }}"
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_a' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasea_schuin_d828_manual_mode
                continue_on_error: true
          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_b' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.faseb_plat_v3_9a7d_manual_mode
                continue_on_error: true
          - conditions:
              - condition: template
                value_template: "{{ assist_bat == 'fase_c' }}"
            sequence:
              - service: button.press
                target:
                  entity_id: button.fasec_geen_deb8_manual_mode
                continue_on_error: true
      - service: input_text.set_value
        target:
          entity_id: input_text.peak_assist_battery_fase
        data:
          value: ""
      - service: timer.cancel
        target:
          entity_id: timer.peak_assist_timer
      - service: logbook.log
        data:
          name: "Peak Assist"
          message: "{{ assist_bat | replace('fase_a', 'Fase A') | replace('fase_b', 'Fase B') | replace('fase_c', 'Fase C') }} handmatig gestopt"
          entity_id: input_text.peak_assist_battery_fase
      - service: notify.persistent_notification
        data:
          title: "‚ö° Marstek - Peak Assist Gestopt"
          message: "Peak assist handmatig gestopt"

  # Clear all manual schedules (troubleshooting/maintenance)
  marstek_clear_all_schedules:
    alias: "Marstek: Clear All Manual Schedules"
    icon: mdi:broom
    sequence:
      # Start notificatie
      - service: notify.persistent_notification
        data:
          title: "üßπ Marstek - Manual Schedule Cleanup"
          message: "Bezig met wissen van alle manual schedules..."

      # Clear schedules Fase A
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "c1fbfff25b11fcecf3530135b0b08f2c"  # Fase A
        continue_on_error: true

      - delay:
          seconds: 1

      # Clear schedules Fase B
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "79ea26ebcb0b77cc1e4acd1cc5af41f6"  # Fase B
        continue_on_error: true

      - delay:
          seconds: 1

      # Clear schedules Fase C
      - service: marstek_local_api.clear_manual_schedules
        data:
          device_id: "f15b9f6024d9a2b044ca90e77824a314"  # Fase C
        continue_on_error: true

      # Logbook entry
      - service: logbook.log
        data:
          name: "Manual Schedule Cleanup"
          message: "Alle manual schedules handmatig gewist door gebruiker"
          entity_id: input_boolean.battery_rotation_enabled

      # Success notificatie
      - service: notify.persistent_notification
        data:
          title: "‚úÖ Marstek - Cleanup Voltooid"
          message: "Alle manual schedules gewist. Je kunt nu veilig nieuwe schedules instellen."
