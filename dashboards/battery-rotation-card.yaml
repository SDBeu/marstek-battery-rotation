type: vertical-stack
cards:
  # Tab Selector (acts as navigation)
  - type: entities
    entities:
      - entity: input_select.dashboard_tab
        name: üìë Dashboard Sectie

  # ==========================================================================
  # TAB 1: STATUS - Real-time Monitoring
  # ==========================================================================
  - type: conditional
    conditions:
      - entity: input_select.dashboard_tab
        state: "Status"
    card:
      type: vertical-stack
      cards:
        # Status Header
        - type: markdown
          content: |
            ## üîã Marstek Batterij Rotatie

            **Actieve Batterij:** {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}
            {% set overflow = states('input_text.overflow_battery_fase') %}
            {% if overflow not in ['', 'unknown', 'unavailable'] %}
            **Overflow:** {{ overflow|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }} ‚ö°
            {% endif %}
            {% set peak_assist = states('input_text.peak_assist_battery_fase') %}
            {% if peak_assist not in ['', 'unknown', 'unavailable'] %}
            **Peak Assist:** {{ peak_assist|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }} ‚ö°
            {% endif %}

            ### P1 Meter: **{{ states('sensor.p1_meter_power') }}W**
            {% set p1 = states('sensor.p1_meter_power')|float(0) %}
            {% if p1 < -200 %}
            {% set sensor = states.binary_sensor.marstek_solar_excess_zone %}
            ‚Üí ‚òÄÔ∏è Teruglevering | üïê **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
            {% elif p1 > 200 %}
            {% set sensor = states.binary_sensor.marstek_grid_consumption_zone %}
            ‚Üí ‚ö° Verbruik | üïê **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
            {% else %}
            ‚Üí ‚öñÔ∏è Binnen drempel
            {% endif %}

            **Laatste Switch:** {% set last_switch = states('input_datetime.last_battery_switch') %}{{ as_timestamp(last_switch) | timestamp_custom('%H:%M', true) if last_switch not in ['unknown', 'unavailable'] else '?' }}

        # Overflow Charging Status (conditional)
        - type: conditional
          conditions:
            - entity: input_text.overflow_battery_fase
              state_not: ""
            - entity: input_text.overflow_battery_fase
              state_not: "unknown"
          card:
            type: vertical-stack
            cards:
              - type: markdown
                content: |
                  ### ‚ö° Overflow Charging Actief

                  **Overflow Batterij:** {{ states('input_text.overflow_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}

                  Tweede batterij laadt in **Passive mode** om PV overflow op te vangen.
                  Stopt automatisch bij verbruik (P1 > 100W) of na {{ states('input_number.overflow_duration')|int(15) }} minuten.

              - type: entities
                entities:
                  - entity: timer.overflow_charging_timer
                    name: Resterende Tijd

        # Peak Assist Status (conditional)
        - type: conditional
          conditions:
            - entity: input_text.peak_assist_battery_fase
              state_not: ""
            - entity: input_text.peak_assist_battery_fase
              state_not: "unknown"
          card:
            type: vertical-stack
            cards:
              - type: markdown
                content: |
                  ### ‚ö° Peak Assist Actief

                  **Assist Batterij:** {{ states('input_text.peak_assist_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}

                  Tweede batterij levert bij in **Passive mode** om verbruikspiek op te vangen.
                  Stopt na {{ states('input_number.peak_assist_duration')|int(5) }} minuten (timer) of via Stop button.

              - type: entities
                entities:
                  - entity: timer.peak_assist_timer
                    name: Resterende Tijd

        # Systeem aan/uit
        - type: entities
          title: Systeem
          entities:
            - entity: input_boolean.battery_rotation_enabled
              name: Batterij Rotatie

        # SOC Overzicht
        - type: horizontal-stack
          cards:
            - type: vertical-stack
              cards:
                - type: gauge
                  entity: sensor.marstek_venuse_d828_state_of_charge
                  name: Fase A (schuin)
                  min: 0
                  max: 100
                  severity:
                    green: 50
                    yellow: 20
                    red: 0
                  needle: true
                - type: markdown
                  content: >
                    {% if states('sensor.marstek_venuse_d828_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
                    {{ states('sensor.marstek_venuse_d828_operating_mode') | default('?') }}

            - type: vertical-stack
              cards:
                - type: gauge
                  entity: sensor.marstek_venuse_3_0_9a7d_state_of_charge
                  name: Fase B (plat)
                  min: 0
                  max: 100
                  severity:
                    green: 50
                    yellow: 20
                    red: 0
                  needle: true
                - type: markdown
                  content: >
                    {% if states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
                    {{ states('sensor.marstek_venuse_3_0_9a7d_operating_mode') | default('?') }}

            - type: vertical-stack
              cards:
                - type: gauge
                  entity: sensor.marstek_venuse_state_of_charge
                  name: Fase C (geen)
                  min: 0
                  max: 100
                  severity:
                    green: 50
                    yellow: 20
                    red: 0
                  needle: true
                - type: markdown
                  content: >
                    {% if states('sensor.marstek_venuse_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
                    {{ states('sensor.marstek_venuse_operating_mode') | default('?') }}

        # Capaciteit overzicht
        - type: entities
          title: ‚ö° Capaciteit
          entities:
            - entity: sensor.marstek_venuse_d828_remaining_capacity
              name: Fase A (schuin)
              icon: mdi:battery
            - entity: sensor.marstek_fase_b_remaining_capacity
              name: Fase B (plat)
              icon: mdi:battery
            - entity: sensor.marstek_venuse_remaining_capacity
              name: Fase C (geen)
              icon: mdi:battery
            - type: divider
            - entity: sensor.marstek_system_total_remaining_capacity_2
              name: Totaal Systeem
              icon: mdi:battery-high

        # Automatische Selectie
        - type: entities
          title: Automatische Selectie
          entities:
            - entity: sensor.battery_emptiest
              name: Leegste Batterij
              icon: mdi:battery-low
            - entity: sensor.battery_fullest
              name: Volste Batterij
              icon: mdi:battery-high

        # Batterij power per fase
        - type: entities
          title: üîå Batterij Power per Fase
          entities:
            - sensor.marstek_fase_a_power
            - sensor.marstek_fase_b_power
            - sensor.marstek_fase_c_power

  # ==========================================================================
  # TAB 2: NACHTLADEN - Planning
  # ==========================================================================
  - type: conditional
    conditions:
      - entity: input_select.dashboard_tab
        state: "Nachtladen"
    card:
      type: vertical-stack
      cards:
        # Nachtladen configuratie
        - type: entities
          title: üåô Nachtladen
          entities:
            - entity: input_select.night_charging_mode
              name: Laadmodus
            - type: divider
            - entity: input_number.desired_total_capacity
              name: Gewenste Capaciteit bij Dagstart
            - entity: sensor.marstek_capacity_deficit
              name: Batterij Deficit
            - entity: sensor.marstek_night_hours
              name: Nachtmodus Duur

        # Piekbewust Status (conditional)
        - type: conditional
          conditions:
            - entity: input_select.night_charging_mode
              state: "Piekbewust Laden"
          card:
            type: entities
            title: üìä Piekbewust Status
            entities:
              - entity: input_number.night_charging_power
                name: Laadvermogen
              - type: divider
              - entity: sensor.marstek_safe_to_charge
                name: Veilig om te Laden
                icon: mdi:shield-check
              - entity: input_boolean.night_charging_active
                name: Piekbewust Laden Actief
              - entity: input_text.night_charging_current_battery
                name: Huidige Laadbatterij
              - type: attribute
                entity: sensor.marstek_safe_to_charge
                attribute: current_avg
                name: Huidig Kwartiergemiddelde
                suffix: " W"
              - type: attribute
                entity: sensor.marstek_safe_to_charge
                attribute: monthly_peak
                name: Maandpiek
                suffix: " W"
              - type: attribute
                entity: sensor.marstek_safe_to_charge
                attribute: headroom
                name: Beschikbare Ruimte
                suffix: " W"

        # Zonnevoorspelling
        - type: entities
          title: ‚òÄÔ∏è PV Voorspelling Morgen
          entities:
            - entity: input_number.pv_production_per_sunny_hour
              name: Productie per Zonuur
            - entity: sensor.marstek_sunny_hours_tomorrow
              name: Zonuren Morgen
            - entity: sensor.marstek_expected_pv_tomorrow
              name: Verwachte PV Productie

        # Laadplan
        - type: entities
          title: üîã Laadplan
          entities:
            - entity: sensor.marstek_net_charging_deficit
              name: Netto Te Laden
              icon: mdi:battery-charging-outline
            - entity: sensor.marstek_required_charging_power
              name: Totaal Laadvermogen (nu)
              icon: mdi:flash
            - entity: sensor.marstek_estimated_charging_power
              name: Geschat Laadvermogen
              icon: mdi:flash-outline
            - entity: sensor.marstek_charging_plan
              name: Laadplan Vannacht
              icon: mdi:battery-charging-wireless

  # ==========================================================================
  # TAB 3: BESTURING - Manual Controls
  # ==========================================================================
  - type: conditional
    conditions:
      - entity: input_select.dashboard_tab
        state: "Besturing"
    card:
      type: vertical-stack
      cards:
        # Manuele Controle
        - type: entities
          title: üîã Manuele Batterij Activatie
          entities:
            - type: button
              name: Activeer Fase A
              icon: mdi:battery-charging-50
              action_name: Activeer
              tap_action:
                action: call-service
                service: script.marstek_activate_fase_a
            - type: button
              name: Activeer Fase B
              icon: mdi:battery-charging-50
              action_name: Activeer
              tap_action:
                action: call-service
                service: script.marstek_activate_fase_b
            - type: button
              name: Activeer Fase C
              icon: mdi:battery-charging-50
              action_name: Activeer
              tap_action:
                action: call-service
                service: script.marstek_activate_fase_c

        # Overflow Controle
        - type: entities
          title: ‚ö° Overflow Charging (PV Overschot)
          entities:
            - type: button
              name: Overflow Fase A
              icon: mdi:battery-plus
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_overflow_fase_a
            - type: button
              name: Overflow Fase B
              icon: mdi:battery-plus
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_overflow_fase_b
            - type: button
              name: Overflow Fase C
              icon: mdi:battery-plus
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_overflow_fase_c
            - type: button
              name: Stop Overflow
              icon: mdi:battery-minus
              action_name: Stop
              tap_action:
                action: call-service
                service: script.marstek_overflow_stop

        # Peak Assist Controle
        - type: entities
          title: ‚ö° Peak Assist (Verbruikspiek)
          entities:
            - type: button
              name: Peak Assist Fase A
              icon: mdi:battery-arrow-down
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_peak_assist_fase_a
            - type: button
              name: Peak Assist Fase B
              icon: mdi:battery-arrow-down
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_peak_assist_fase_b
            - type: button
              name: Peak Assist Fase C
              icon: mdi:battery-arrow-down
              action_name: Start
              tap_action:
                action: call-service
                service: script.marstek_peak_assist_fase_c
            - type: button
              name: Stop Peak Assist
              icon: mdi:stop
              action_name: Stop
              tap_action:
                action: call-service
                service: script.marstek_peak_assist_stop

        # Emergency Stop
        - type: entities
          entities:
            - type: button
              name: üõë Emergency Stop - Alle batterijen naar Manual
              icon: mdi:stop-circle
              action_name: STOP
              tap_action:
                action: call-service
                service: script.marstek_all_batteries_manual
                confirmation:
                  text: Weet je zeker dat je alle batterijen wilt stoppen?

        # Manual Schedule Cleanup
        - type: entities
          entities:
            - type: button
              name: üßπ Clear Manual Schedules
              icon: mdi:broom
              action_name: Wissen
              tap_action:
                action: call-service
                service: script.marstek_clear_all_schedules
                confirmation:
                  text: Dit wist alle manual schedules van alle batterijen. Doorgaan?

  # ==========================================================================
  # TAB 4: INSTELLINGEN - Configuration
  # ==========================================================================
  - type: conditional
    conditions:
      - entity: input_select.dashboard_tab
        state: "Instellingen"
    card:
      type: vertical-stack
      cards:
        # Algemeen
        - type: entities
          title: ‚öôÔ∏è Algemeen
          entities:
            - entity: input_number.battery_switch_delay_minutes
              name: Min. Tijd Tussen Switches
            - type: divider
            - entity: input_datetime.night_mode_start_time
              name: Nachtmodus Start
            - entity: input_datetime.day_mode_start_time
              name: Dagmodus Start
            - type: divider
            - entity: input_boolean.clear_schedules_before_night_charging
              name: Clear Schedules Voor Nachtladen

        # Overflow Instellingen
        - type: entities
          title: ‚ö° Overflow Charging
          entities:
            - entity: input_number.overflow_power
              name: Laadvermogen
            - entity: input_number.overflow_duration
              name: Duur

        # Peak Assist Instellingen
        - type: entities
          title: ‚ö° Peak Assist
          entities:
            - entity: input_number.peak_assist_power
              name: Ontlaadvermogen
            - entity: input_number.peak_assist_duration
              name: Duur

  # ==========================================================================
  # TAB 5: LOGBOEK - History
  # ==========================================================================
  - type: conditional
    conditions:
      - entity: input_select.dashboard_tab
        state: "Logboek"
    card:
      type: vertical-stack
      cards:
        # Recente Activiteit
        - type: logbook
          title: üìã Recente Activiteit
          hours_to_show: 24
          entities:
            - input_text.active_battery_fase
            - input_text.overflow_battery_fase
            - input_text.peak_assist_battery_fase
            - input_boolean.battery_rotation_enabled
            - input_boolean.night_charging_active
            - input_text.night_charging_current_battery
            - automation.marstek_solar_excess_switch_to_emptiest
            - automation.marstek_grid_consumption_switch_to_fullest
            - automation.marstek_overflow_charging_start
            - automation.marstek_overflow_charging_stop
            - automation.marstek_overflow_charging_timer_finished
            - automation.marstek_peak_assist_start
            - automation.marstek_peak_assist_timer_finished
            - automation.marstek_peak_aware_night_charging_start
            - automation.marstek_peak_aware_night_charging_pause
            - automation.marstek_peak_aware_night_charging_resume
            - automation.marstek_peak_aware_night_charging_next_battery
