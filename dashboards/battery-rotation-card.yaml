type: vertical-stack
cards:
  # Status Header
  - type: markdown
    content: |
      ## üîã Marstek Batterij Rotatie

      **Actieve Batterij:** {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}
      {% set overflow = states('input_text.overflow_battery_fase') %}
      {% if overflow not in ['', 'unknown', 'unavailable'] %}
      **Overflow:** {{ overflow|replace('fase_a', 'Fase A')|replace('fase_b', 'Fase B')|replace('fase_c', 'Fase C') }} ‚ö°
      {% endif %}

      **P1 Meter:** {{ states('sensor.p1_meter_power') }}W
      {% set p1 = states('sensor.p1_meter_power')|float(0) %}
      {% if p1 < -200 %}
      {% set sensor = states.binary_sensor.marstek_solar_excess_zone %}
      ‚Üí ‚òÄÔ∏è Teruglevering | üïê **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
      {% elif p1 > 200 %}
      {% set sensor = states.binary_sensor.marstek_grid_consumption_zone %}
      ‚Üí ‚ö° Verbruik | üïê **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
      {% else %}
      ‚Üí ‚öñÔ∏è Binnen drempel
      {% endif %}

      **Laatste Switch:** {% set last_switch = states('input_datetime.last_battery_switch') %}{{ as_timestamp(last_switch) | timestamp_custom('%H:%M', true) if last_switch not in ['unknown', 'unavailable'] else '?' }}

  # Overflow Charging Status (alleen zichtbaar bij actieve overflow)
  - type: conditional
    conditions:
      - entity: input_text.overflow_battery_fase
        state_not: ""
      - entity: input_text.overflow_battery_fase
        state_not: "unknown"
    card:
      type: markdown
      content: |
        ### ‚ö° Overflow Charging Actief

        **Overflow Batterij:** {{ states('input_text.overflow_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}

        Tweede batterij laadt in **Passive mode** om PV overflow op te vangen.
        Stopt automatisch bij verbruik (P1 > 100W).

  # Systeem aan/uit
  - type: entities
    title: Systeem
    entities:
      - entity: input_boolean.battery_rotation_enabled
        name: Batterij Rotatie

  # Capaciteit overzicht
  - type: entities
    title: ‚ö° Capaciteit
    entities:
      - entity: sensor.marstek_venuse_d828_remaining_capacity
        name: Fase A (schuin)
        icon: mdi:battery
      - entity: sensor.marstek_venuse_3_0_9a7d_remaining_capacity
        name: Fase B (plat)
        icon: mdi:battery
      - entity: sensor.marstek_venuse_remaining_capacity
        name: Fase C (geen)
        icon: mdi:battery
      - type: divider
      - entity: sensor.marstek_system_total_remaining_capacity_2
        name: Totaal Systeem
        icon: mdi:battery-high

  # SOC Overzicht met Status
  - type: horizontal-stack
    cards:
      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_d828_state_of_charge
            name: Fase A (schuin)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_d828_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
              {{ states('sensor.marstek_venuse_d828_operating_mode') | default('?') }}

      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_3_0_9a7d_state_of_charge
            name: Fase B (plat)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
              {{ states('sensor.marstek_venuse_3_0_9a7d_operating_mode') | default('?') }}

      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_state_of_charge
            name: Fase C (geen)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_state_of_charge') not in ['unavailable', 'unknown'] %}üü¢{% else %}üî¥{% endif %}
              {{ states('sensor.marstek_venuse_operating_mode') | default('?') }}

  # Automatische Selectie
  - type: entities
    title: Automatische Selectie
    entities:
      - entity: sensor.battery_emptiest
        name: Leegste Batterij
        icon: mdi:battery-low
      - entity: sensor.battery_fullest
        name: Volste Batterij
        icon: mdi:battery-high

  # Manuele Controle
  - type: horizontal-stack
    cards:
      - type: button
        name: Activeer Fase A
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_a

      - type: button
        name: Activeer Fase B
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_b

      - type: button
        name: Activeer Fase C
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_c

  # Overflow Controle
  - type: horizontal-stack
    cards:
      - type: button
        name: Overflow A
        icon: mdi:battery-plus
        tap_action:
          action: call-service
          service: script.marstek_overflow_fase_a

      - type: button
        name: Overflow B
        icon: mdi:battery-plus
        tap_action:
          action: call-service
          service: script.marstek_overflow_fase_b

      - type: button
        name: Overflow C
        icon: mdi:battery-plus
        tap_action:
          action: call-service
          service: script.marstek_overflow_fase_c

      - type: button
        name: Stop
        icon: mdi:battery-minus
        tap_action:
          action: call-service
          service: script.marstek_overflow_stop

  # Emergency Stop
  - type: button
    name: üõë STOP - Alle naar Manual
    icon: mdi:stop-circle
    tap_action:
      action: call-service
      service: script.marstek_all_batteries_manual
      confirmation:
        text: Weet je zeker dat je alle batterijen wilt stoppen?

  # Recente Activiteit
  - type: logbook
    title: üìã Recente Activiteit
    hours_to_show: 24
    entities:
      - input_text.active_battery_fase
      - input_boolean.battery_rotation_enabled
      - automation.marstek_solar_excess_switch_to_emptiest
      - automation.marstek_grid_consumption_switch_to_fullest

  # Instellingen
  - type: entities
    title: ‚öôÔ∏è Instellingen
    entities:
      - entity: input_number.battery_switch_delay_minutes
        name: Min. Tijd Tussen Switches
      - type: divider
      - entity: input_datetime.night_mode_start_time
        name: Nachtmodus Start
      - entity: input_datetime.day_mode_start_time
        name: Dagmodus Start

  # Nachtladen
  - type: entities
    title: üåô Nachtladen
    entities:
      - entity: input_number.desired_total_capacity
        name: Gewenste Capaciteit bij Dagstart
      - type: divider
      - entity: sensor.marstek_capacity_deficit
        name: Batterij Deficit
      - entity: sensor.marstek_night_hours
        name: Nachtmodus Duur

  # Zonnevoorspelling
  - type: entities
    title: ‚òÄÔ∏è PV Voorspelling Morgen
    entities:
      - entity: input_number.pv_production_per_sunny_hour
        name: Productie per Zonuur
      - entity: sensor.marstek_sunny_hours_tomorrow
        name: Zonuren Morgen
      - entity: sensor.marstek_expected_pv_tomorrow
        name: Verwachte PV Productie
      - type: divider
      - entity: sensor.marstek_net_charging_deficit
        name: Netto Te Laden
        icon: mdi:battery-charging-outline
      - entity: sensor.marstek_required_charging_power
        name: Totaal Laadvermogen (nu)
        icon: mdi:flash
      - entity: sensor.marstek_estimated_charging_power
        name: Geschat Laadvermogen
        icon: mdi:flash-outline
      - entity: sensor.marstek_charging_plan
        name: Laadplan Vannacht
        icon: mdi:battery-charging-wireless
