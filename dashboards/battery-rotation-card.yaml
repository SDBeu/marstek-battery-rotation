type: vertical-stack
cards:
  # Status Header
  - type: markdown
    content: |
      ## ğŸ”‹ Marstek Batterij Rotatie

      **Actieve Batterij:** {{ states('input_text.active_battery_fase')|replace('fase_a', 'Fase A (schuin)')|replace('fase_b', 'Fase B (plat)')|replace('fase_c', 'Fase C (geen)') }}

      **P1 Meter:** {{ states('sensor.p1_meter_power') }}W
      {% set p1 = states('sensor.p1_meter_power')|float(0) %}
      {% if p1 < -200 %}
      {% set sensor = states.binary_sensor.marstek_solar_excess_zone %}
      â†’ â˜€ï¸ Teruglevering | ğŸ• **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
      {% elif p1 > 200 %}
      {% set sensor = states.binary_sensor.marstek_grid_consumption_zone %}
      â†’ âš¡ Verbruik | ğŸ• **{{ (as_timestamp(now()) - as_timestamp(sensor.last_changed))|int if sensor else '?' }}s** / 120s
      {% else %}
      â†’ âš–ï¸ Binnen drempel
      {% endif %}

      **Laatste Switch:** {{ as_timestamp(states('input_datetime.last_battery_switch')) | timestamp_custom('%H:%M', true) }}

  # Systeem aan/uit
  - type: entities
    title: Systeem
    entities:
      - entity: input_boolean.battery_rotation_enabled
        name: Batterij Rotatie

  # SOC Overzicht met Status
  - type: horizontal-stack
    cards:
      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_d828_state_of_charge
            name: Fase A (schuin)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_d828_state_of_charge') not in ['unavailable', 'unknown'] %}ğŸŸ¢{% else %}ğŸ”´{% endif %}
              {{ states('sensor.marstek_venuse_d828_operating_mode') | default('?') }}

      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_3_0_9a7d_state_of_charge
            name: Fase B (plat)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_3_0_9a7d_state_of_charge') not in ['unavailable', 'unknown'] %}ğŸŸ¢{% else %}ğŸ”´{% endif %}
              {{ states('sensor.marstek_venuse_3_0_9a7d_operating_mode') | default('?') }}

      - type: vertical-stack
        cards:
          - type: gauge
            entity: sensor.marstek_venuse_state_of_charge
            name: Fase C (geen)
            min: 0
            max: 100
            severity:
              green: 50
              yellow: 20
              red: 0
            needle: true
          - type: markdown
            content: >
              {% if states('sensor.marstek_venuse_state_of_charge') not in ['unavailable', 'unknown'] %}ğŸŸ¢{% else %}ğŸ”´{% endif %}
              {{ states('sensor.marstek_venuse_operating_mode') | default('?') }}

  # Automatische Selectie
  - type: entities
    title: Automatische Selectie
    entities:
      - entity: sensor.battery_emptiest
        name: Leegste Batterij
        icon: mdi:battery-low
      - entity: sensor.battery_fullest
        name: Volste Batterij
        icon: mdi:battery-high

  # Manuele Controle
  - type: horizontal-stack
    cards:
      - type: button
        name: Activeer Fase A
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_a

      - type: button
        name: Activeer Fase B
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_b

      - type: button
        name: Activeer Fase C
        icon: mdi:battery-charging-50
        tap_action:
          action: call-service
          service: script.marstek_activate_fase_c

  # Emergency Stop
  - type: button
    name: ğŸ›‘ STOP - Alle naar Manual
    icon: mdi:stop-circle
    tap_action:
      action: call-service
      service: script.marstek_all_batteries_manual
      confirmation:
        text: Weet je zeker dat je alle batterijen wilt stoppen?

  # Recente Activiteit
  - type: logbook
    title: ğŸ“‹ Recente Activiteit
    hours_to_show: 24
    entities:
      - input_text.active_battery_fase
      - input_boolean.battery_rotation_enabled
      - automation.marstek_solar_excess_switch_to_emptiest
      - automation.marstek_grid_consumption_switch_to_fullest

  # Instellingen
  - type: entities
    title: âš™ï¸ Instellingen
    entities:
      - entity: input_number.battery_switch_delay_minutes
        name: Min. Tijd Tussen Switches
      - type: divider
      - entity: input_datetime.night_mode_start_time
        name: Nachtmodus Start
      - entity: input_datetime.day_mode_start_time
        name: Dagmodus Start
